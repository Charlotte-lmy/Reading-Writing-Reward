<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é˜…è¯» & å†™ä½œå°çƒŸèŠ± Â· æ­£åé¦ˆå·¥å…·ï¼ˆå…¨æ–°ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      margin:0;min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Segoe UI","PingFang SC",sans-serif;
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(circle at top,#fce4ec,#e3f2fd);
    }
    .card{
      background:#ffffffcc;backdrop-filter:blur(8px);
      padding:20px 22px;border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      max-width:620px;width:94%;box-sizing:border-box;
    }
    h1{font-size:20px;margin:0 0 8px;text-align:center;}
    .subtitle{font-size:13px;color:#666;text-align:center;margin-bottom:10px;}
    .mode-switch{
      display:flex;gap:8px;background:#f3e5f5aa;padding:4px;border-radius:999px;
      margin:8px auto 14px;max-width:280px;
    }
    .mode-btn{
      flex:1;border-radius:999px;border:none;padding:6px 0;font-size:13px;cursor:pointer;
      background:transparent;color:#555;transition:background .2s,color .2s,transform .1s;
    }
    .mode-btn.active{
      background:linear-gradient(135deg,#ff80ab,#7c4dff);color:#fff;font-weight:600;transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(124,77,255,.35);
    }
    label{font-size:14px;display:block;margin-bottom:4px;}
    input[type="number"],input[type="text"],input[type="date"],select{
      width:100%;padding:7px 9px;border-radius:8px;border:1px solid #ccc;
      font-size:13px;box-sizing:border-box;margin-bottom:6px;background:#fff;
    }
    .hint{font-size:11px;color:#888;margin-bottom:4px;}
    .btn{
      margin-top:6px;width:100%;padding:10px 0;font-size:15px;border-radius:999px;border:none;cursor:pointer;
      background:linear-gradient(135deg,#ff80ab,#7c4dff);color:#fff;font-weight:600;
      transition:transform .1s,box-shadow .1s,opacity .2s;box-shadow:0 6px 15px rgba(124,77,255,.35);
    }
    .btn:active{transform:translateY(1px) scale(.99);box-shadow:0 3px 8px rgba(124,77,255,.3);}
    .btn-secondary{
      margin-top:8px;width:100%;padding:9px 0;font-size:13px;border-radius:999px;border:1px solid #d7d7d7;
      cursor:pointer;background:rgba(255,255,255,.85);color:#444;
    }
    .btn-row{display:flex;gap:8px;margin-top:6px;}
    .btn-small{
      flex:1;padding:8px 0;font-size:12px;border-radius:999px;border:1px solid #d7d7d7;
      cursor:pointer;background:rgba(255,255,255,.9);color:#333;
    }
    .btn-small.primary{
      border:none;background:linear-gradient(135deg,#ff80ab,#7c4dff);color:#fff;font-weight:600;
      box-shadow:0 6px 15px rgba(124,77,255,.25);
    }
    .btn-small.active{
      border:none;color:#fff;font-weight:600;
      background:linear-gradient(135deg,#ff80ab,#7c4dff);
      box-shadow:0 6px 15px rgba(124,77,255,.22);
    }
    .hidden{display:none;}

    .progress-container{margin-top:14px;}
    .progress-text{font-size:14px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:baseline;}
    .progress-main{font-weight:600;}
    .progress-percent{font-size:12px;color:#666;}
    .progress-bar{width:100%;height:10px;border-radius:999px;background:#eee;overflow:hidden;}
    .progress-bar-inner{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,#ff80ab,#7c4dff);transition:width .25s ease;}
    .status-text{margin-top:6px;font-size:13px;color:#555;text-align:center;}
    .current-label{margin-top:4px;font-size:12px;color:#777;text-align:center;}
    .current-label span{font-weight:600;color:#5e35b1;}

    .celebrate-area{position:relative;margin-top:14px;height:70px;overflow:visible;}
    .celebrate-item{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-size:30px;pointer-events:none;animation:pop-up 900ms ease-out forwards;
    }
    @keyframes pop-up{
      0%{transform:translate(-50%,-30%) scale(.4);opacity:0;}
      40%{transform:translate(-50%,-60%) scale(1.1);opacity:1;}
      100%{transform:translate(-50%,-110%) scale(.7);opacity:0;}
    }
    .message{margin-top:4px;font-size:13px;text-align:center;color:#444;min-height:20px;}
    .message-strong{font-weight:600;color:#ff4081;}

    .history-section{margin-top:14px;border-top:1px dashed #ddd;padding-top:8px;}
    .history-title{font-size:12px;color:#777;margin-bottom:4px;}
    .week-summary{font-size:11px;color:#555;margin-bottom:4px;}
    .history-list{font-size:11px;color:#555;max-height:110px;overflow-y:auto;}
    .history-item{display:flex;justify-content:space-between;margin-bottom:2px;}
    .history-date{flex:0 0 auto;margin-right:6px;}
    .history-detail{flex:1;text-align:right;}

    .all-reading-section{margin-top:14px;border-top:1px dashed #ddd;padding-top:8px;}
    .all-reading-title{font-size:12px;color:#777;margin-bottom:4px;}
    .all-reading-table{
      max-height:210px;overflow-y:auto;border-radius:8px;background:#fafafa;padding:6px;box-sizing:border-box;margin-bottom:8px;
    }
    table.reading-table{width:100%;border-collapse:collapse;font-size:11px;color:#555;}
    table.reading-table th, table.reading-table td{
      padding:2px 4px;text-align:left;border-bottom:1px solid #eee;white-space:nowrap;vertical-align:top;
    }
    table.reading-table th{font-weight:600;color:#666;}
    .actions a{cursor:pointer;text-decoration:underline;color:#5e35b1;margin-right:8px;}

    .chart-note{font-size:11px;color:#777;margin-bottom:4px;}
    .chart{
      height:220px;display:flex;align-items:flex-end;overflow-x:auto;gap:10px;padding:8px 6px 10px;box-sizing:border-box;
      background:#fafafa;border-radius:8px;
    }
    .chart-bar-wrapper{
      flex:0 0 32px;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;min-width:16px;
    }
    .chart-bar{
      width:100%;max-width:32px;min-height:6px;border-radius:999px 999px 0 0;
      background:linear-gradient(135deg,#ff80ab,#7c4dff);transition:height .2s ease;
    }
    .chart-bar.streak{outline:2px solid rgba(0,0,0,.35);box-shadow:0 2px 8px rgba(0,0,0,.12);}
    .chart-bar-label{margin-top:2px;font-size:9px;color:#777;text-align:center;transform:scale(.9);white-space:pre;}

    .footer-tip{margin-top:8px;font-size:11px;text-align:center;color:#999;}
    @media(max-width:480px){.card{padding:16px 16px;border-radius:16px;}h1{font-size:18px;}.subtitle{font-size:12px;}}
  </style>
</head>

<body>
  <div class="card">
    <h1>ğŸ¦Š é˜…è¯» & å†™ä½œå°çƒŸèŠ±</h1>
    <div class="subtitle">Small steps, real progress.</div>

    <div class="mode-switch">
      <button class="mode-btn active" data-mode="read">ğŸ“– é˜…è¯»æ¨¡å¼</button>
      <button class="mode-btn" data-mode="write">âœï¸ å†™ä½œæ¨¡å¼</button>
    </div>

    <!-- è®¾å®šç›®æ ‡ -->
    <div id="setup-section">
      <label id="total-label" for="total-input">ä»Šå¤©æ‰“ç®—è¯»å¤šå°‘é¡µï¼Ÿ</label>
      <input type="number" id="total-input" min="1" placeholder="ä¾‹å¦‚ï¼š30" />

      <div id="read-title-block">
        <label for="book-input">ä¹¦åï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="book-input" placeholder="ï¼ˆå¯ä¸å¡«ï¼‰" list="book-suggestions" />
        <datalist id="book-suggestions"></datalist>
      </div>

      <div id="write-label-block" class="hidden">
        <label for="label-input">è¿™ä¸ªä»»åŠ¡å±äºå“ªä¸ªé¡¹ç›®ï¼Ÿ</label>
        <div class="hint">ä¾‹å¦‚ï¼šè®ºæ–‡ / è‹±æ–‡å†™ä½œ / æ—¥è®°ï¼ˆå¯ç•™ç©ºï¼‰</div>
        <input type="text" id="label-input" placeholder="é¡¹ç›®åç§°ï¼ˆå¯é€‰ï¼‰" />
      </div>

      <button class="btn" id="start-btn">æ·»åŠ ä¸€ä¸ªä»»åŠ¡å¹¶å¼€å§‹</button>
      <div class="hint" style="margin-top:8px;">åŒä¸€å¤©å¯ä»¥æ·»åŠ å¤šä¸ªä»»åŠ¡ï¼Œä¸ä¼šäº’ç›¸è¦†ç›–ã€‚</div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-section" class="hidden">
      <div style="margin-top:6px;">
        <label style="font-size:12px;color:#666;">å½“å‰ä¹¦ / å½“å‰ä»»åŠ¡</label>
        <select id="task-select"></select>
        <div class="hint">åˆ‡æ¢å½“å‰ä»»åŠ¡ï¼šç”¨ä¸‹æ‹‰æ¡†é€‰æ‹©</div>
      </div>

      <div class="progress-container">
        <div class="progress-text">
          <div class="progress-main" id="progress-main-text">å·²å®Œæˆ 0 / 0</div>
          <div class="progress-percent" id="progress-percent-text">0%</div>
        </div>
        <div class="progress-bar"><div class="progress-bar-inner" id="progress-bar-inner"></div></div>
        <div class="status-text" id="status-text">æ…¢æ…¢æ¥ï¼Œæ¯ä¸€ç‚¹éƒ½ç®—æ•° âœ¨</div>
        <div class="current-label" id="current-label"></div>
      </div>

      <button class="btn" id="done-btn">å®Œæˆä¸€é¡µ âœ…</button>
      <button class="btn-secondary" id="add-task-btn">â• å†æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼ˆå¦ä¸€æœ¬ä¹¦ / å¦ä¸€æ®µå†™ä½œï¼‰</button>

      <div class="celebrate-area" id="celebrate-area"></div>
      <div class="message" id="message"></div>

      <div class="history-section">
        <div class="history-title">æœ€è¿‘ 7 å¤©ï¼ˆå½“å‰æ¨¡å¼ï¼‰</div>
        <div class="week-summary" id="week-summary"></div>
        <div class="history-list" id="history-list"></div>
      </div>

      <!-- é˜…è¯»ç»Ÿè®¡ + è§£é¢˜è®¡æ•°æ¿ -->
      <div class="all-reading-section" id="all-reading-section">
        <div class="all-reading-title">ğŸ“Š æ€»é¢æ¿ï¼ˆé˜…è¯» + è§£é¢˜ï¼‰</div>
        <div class="hint" id="reading-total-all" style="margin:4px 0 8px;">
          ç´¯è®¡é˜…è¯»ï¼š0 é¡µ ï½œ ç´¯è®¡å¤©æ•°ï¼š0 å¤© ï½œ å¹³å‡æ¯å¤©ï¼š0.0 é¡µ/å¤© ï½œ è¿ç»­é˜…è¯»ï¼š0 å¤© ï½œ è¿ç»­é¡µæ•°ï¼š0 é¡µ ï½œ ä»Šæ—¥è§£é¢˜ï¼š0 ï½œ ç´¯è®¡è§£é¢˜ï¼š0
        </div>

        <div class="all-reading-title" style="margin-top:10px;">ğŸ§  è§£å†³é—®é¢˜è®¡æ•°æ¿</div>
        <div class="hint" id="solve-stats" style="margin:4px 0 8px;">ä»Šæ—¥ï¼š0ï¼ˆè¯æ±‡0/å®šä¹‰0/å¥æ³•0ï¼‰ï½œ ç´¯è®¡ï¼š0</div>

        <div class="btn-row" style="margin-top:0;">
          <button class="btn-small active" id="solve-cat-vocab">è¯æ±‡</button>
          <button class="btn-small" id="solve-cat-def">å®šä¹‰</button>
          <button class="btn-small" id="solve-cat-syntax">å¥æ³•</button>
        </div>
        <button class="btn" id="solve-btn">æˆ‘è§£å†³äº†ä¸€ä¸ªé—®é¢˜ âœ…</button>
        <div class="hint" style="margin-top:6px;">æ¯å¤© â‰¥ 5 ä¸ªä¼šè§¦å‘ä¸€æ¬¡â€œå°çƒŸèŠ±â€ã€‚</div>

        <div class="all-reading-title" style="margin-top:12px;">æŒ‰å¤©æ±‡æ€»ï¼ˆé˜…è¯»ï¼‰</div>
        <div class="all-reading-table" id="reading-table-container"></div>

        <div class="all-reading-title" style="margin-top:10px;">ğŸ“š æŒ‰ä¹¦æ±‡æ€»ï¼ˆé˜…è¯»ï¼‰</div>
        <div class="all-reading-table" id="book-table-container"></div>

        <div class="chart-note">æœ€è¿‘ 90 å¤©æ¯æ—¥é˜…è¯»é¡µæ•°ï¼ˆä½é¡µæ•°ä¹Ÿä¼šâ€œæŠ¬é«˜â€æ˜¾ç¤ºï¼‰</div>
        <div class="chart" id="reading-chart"></div>

        <!-- å†å²ç¼–è¾‘ -->
        <div class="all-reading-title" style="margin-top:12px;">âœï¸ æ·»åŠ  / ä¿®æ”¹å†å²è®°å½•ï¼ˆé˜…è¯»ï¼‰</div>
        <div class="hint">ä½ å¯ä»¥è¡¥å½•æ˜¨å¤©/ä¹‹å‰çš„è®°å½•ï¼›ä¹Ÿå¯ä»¥åœ¨â€œåŸå§‹è®°å½•â€é‡Œç‚¹ç¼–è¾‘ã€‚</div>
        <input id="edit-date" type="date" />
        <input id="edit-book" type="text" placeholder="ä¹¦åï¼ˆå¯ç•™ç©ºï¼‰" />
        <input id="edit-pages" type="number" min="0" placeholder="å®Œæˆé¡µæ•°ï¼ˆä¾‹å¦‚ 12ï¼‰" />
        <input id="edit-total" type="number" min="0" placeholder="ç›®æ ‡é¡µæ•°ï¼ˆå¯é€‰ï¼Œä¸å¡«=0ï¼‰" />
        <div class="btn-row">
          <button class="btn-small primary" id="save-record-btn">ä¿å­˜ï¼ˆæ–°å¢/æ›´æ–°ï¼‰</button>
          <button class="btn-small" id="clear-editor-btn">æ¸…ç©ºç¼–è¾‘å™¨</button>
        </div>
        <div class="hint" id="edit-status" style="margin-top:6px;"></div>

        <!-- åŸå§‹è®°å½•ï¼ˆæ‰¾ getï¼‰ -->
        <div class="all-reading-title" style="margin-top:12px;">ğŸ” åŸå§‹è®°å½•ï¼ˆå¯æœç´¢ get / gtd / åŸè‘—é˜…è¯»è¥ï¼‰</div>
        <div class="btn-row" style="margin-top:0;">
          <button class="btn-small" id="quick-get-btn">ä¸€é”®ï¼šget</button>
          <button class="btn-small" id="quick-gtd-btn">ä¸€é”®ï¼šgtd</button>
          <button class="btn-small" id="quick-origin-btn">ä¸€é”®ï¼šåŸè‘—é˜…è¯»è¥</button>
        </div>
        <input id="raw-search" type="text" placeholder="è¾“å…¥å…³é”®è¯ï¼Œæ¯”å¦‚ get / gtd / things done / åŸè‘—é˜…è¯»è¥ / ã€Š" style="margin-top:6px;margin-bottom:6px;" />
        <div class="all-reading-table" id="raw-table-container"></div>

        <div class="footer-tip">æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨é‡Œï¼ˆæ¯ä¸ªäººå½¼æ­¤ç‹¬ç«‹ï¼‰</div>
      </div>
    </div>
  </div>

<script>
  // ===== DOM =====
  const modeButtons = document.querySelectorAll(".mode-btn");
  const totalLabel = document.getElementById("total-label");
  const totalInput = document.getElementById("total-input");
  const startBtn = document.getElementById("start-btn");
  const setupSection = document.getElementById("setup-section");
  const mainSection = document.getElementById("main-section");

  const readTitleBlock = document.getElementById("read-title-block");
  const writeLabelBlock = document.getElementById("write-label-block");
  const bookInput = document.getElementById("book-input");
  const bookSuggestions = document.getElementById("book-suggestions");
  const labelInput = document.getElementById("label-input");
  const addTaskBtn = document.getElementById("add-task-btn");

  const taskSelect = document.getElementById("task-select");

  const progressMainText = document.getElementById("progress-main-text");
  const progressPercentText = document.getElementById("progress-percent-text");
  const progressBarInner = document.getElementById("progress-bar-inner");
  const statusText = document.getElementById("status-text");
  const currentLabelEl = document.getElementById("current-label");

  const doneBtn = document.getElementById("done-btn");
  const celebrateArea = document.getElementById("celebrate-area");
  const messageEl = document.getElementById("message");
  const historyList = document.getElementById("history-list");
  const weekSummary = document.getElementById("week-summary");

  const readingTableContainer = document.getElementById("reading-table-container");
  const bookTableContainer = document.getElementById("book-table-container");
  const readingChart = document.getElementById("reading-chart");
  const totalAllEl = document.getElementById("reading-total-all");

  const editDate = document.getElementById("edit-date");
  const editBook = document.getElementById("edit-book");
  const editPages = document.getElementById("edit-pages");
  const editTotal = document.getElementById("edit-total");
  const saveRecordBtn = document.getElementById("save-record-btn");
  const clearEditorBtn = document.getElementById("clear-editor-btn");
  const editStatus = document.getElementById("edit-status");

  const rawSearch = document.getElementById("raw-search");
  const rawTableContainer = document.getElementById("raw-table-container");
  const quickGetBtn = document.getElementById("quick-get-btn");
  const quickGtdBtn = document.getElementById("quick-gtd-btn");
  const quickOriginBtn = document.getElementById("quick-origin-btn");

  // Solve board
  const solveStatsEl = document.getElementById("solve-stats");
  const solveBtn = document.getElementById("solve-btn");
  const solveCatVocab = document.getElementById("solve-cat-vocab");
  const solveCatDef = document.getElementById("solve-cat-def");
  const solveCatSyntax = document.getElementById("solve-cat-syntax");

  // ===== Storage keys =====
  const STORAGE_KEY = "tinyRewardTracker_v3_addon";   // ä¿ç•™æ—§å†å²
  const BOOKS_KEY   = "tinyRewardTracker_books_v1";
  const SOLVE_KEY   = "tinyRewardTracker_solve_v2";   // æ–°ï¼šæŒ‰å¤©+åˆ†ç±»
  const SOLVE_BADGE_KEY = "tinyRewardTracker_solve_badge_v1"; // æ–°ï¼šæ¯æ—¥>=5çš„è§¦å‘è®°å¿†

  // ===== Mode config =====
  let currentMode = "read";
  const MODE_CONFIG = {
    read:  { name: "é˜…è¯»", unit: "é¡µ", totalLabel: "ä»Šå¤©æ‰“ç®—è¯»å¤šå°‘é¡µï¼Ÿ", doneButton: "å®Œæˆä¸€é¡µ âœ…" },
    write: { name: "å†™ä½œ", unit: "å­—", totalLabel: "ä»Šå¤©æ‰“ç®—å†™å¤šå°‘å­—ï¼Ÿ", doneButton: "å†å†™ä¸€ç‚¹ âœ…" }
  };
  const WRITE_STEP = 100;

  const emojis = [
    { icon: "ğŸ¦Š", name: "å°ç‹ç‹¸" }, { icon: "ğŸ±", name: "å°çŒ«å’ª" }, { icon: "ğŸ»", name: "å°ç†Š" },
    { icon: "ğŸ°", name: "å°å…”å­" }, { icon: "ğŸ¼", name: "ç†ŠçŒ«" }, { icon: "ğŸ‰", name: "çƒŸèŠ±" },
    { icon: "âœ¨", name: "æ˜Ÿå…‰" }, { icon: "ğŸŒˆ", name: "å½©è™¹" }
  ];
  const messages = ["ç»§ç»­å°±å¯¹äº†ã€‚","ä½ åœ¨å˜å¼ºã€‚","ä»Šå¤©ä¹Ÿç®—æ•°ã€‚","æ…¢æ…¢æ¥ï¼Œä½†ä¸åœã€‚","ä½ åœ¨å‘å‰ã€‚","åšåˆ°äº†å°±å¾ˆå¥½ã€‚"];

  // ===== State =====
  let state = loadState();
  normalizeHistoryIds();
  saveState();

  let editingRecordId = null;
  let solveCat = "vocab"; // vocab/def/syntax

  function todayString() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }
  function parseDateStr(s) {
    const [y, m, d] = s.split("-").map(Number);
    return new Date(y, m - 1, d);
  }
  function getWeekStartTime(date) {
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const day = (d.getDay() + 6) % 7;
    d.setDate(d.getDate() - day);
    return d.getTime();
  }
  function emptyModeState() { return { todayTasks: [], activeTaskId: null, history: [] }; }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { read: emptyModeState(), write: emptyModeState() };
      const parsed = JSON.parse(raw);

      if (!parsed.read) parsed.read = emptyModeState();
      if (!parsed.write) parsed.write = emptyModeState();

      ["read","write"].forEach(mode => {
        const m = parsed[mode];
        if (!m.history) m.history = [];
        m.history = m.history.map(item => ({
          id: item.id || null,
          date: item.date,
          total: Number(item.total || 0),
          finished: Number(item.finished || 0),
          label: item.label || ""
        }));
        if (!m.todayTasks) m.todayTasks = [];
        if (!m.activeTaskId) m.activeTaskId = null;

        if (m.today && m.today.date) {
          const t = m.today;
          const id = t.id || `legacy-${t.date}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
          m.todayTasks.push({
            id,
            date: t.date,
            total: Number(t.total || 0),
            finished: Number(t.finished || 0),
            label: t.label || ""
          });
          m.activeTaskId = id;
          m.today = null;
        }
      });

      return parsed;
    } catch {
      return { read: emptyModeState(), write: emptyModeState() };
    }
  }
  function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function getModeState(mode) {
    if (!state[mode]) state[mode] = emptyModeState();
    if (!state[mode].todayTasks) state[mode].todayTasks = [];
    if (!state[mode].history) state[mode].history = [];
    return state[mode];
  }
  function normalizeHistoryIds() {
    ["read","write"].forEach(mode => {
      const m = getModeState(mode);
      m.history.forEach((it, idx) => {
        if (!it.id) it.id = `h-${mode}-${it.date || "nodate"}-${idx}-${Math.random().toString(16).slice(2)}`;
      });
      m.todayTasks.forEach((t, idx) => {
        if (!t.id) t.id = `t-${mode}-${t.date || "nodate"}-${idx}-${Math.random().toString(16).slice(2)}`;
      });
    });
  }

  // ===== Utils =====
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // ===== Book suggestions =====
  function loadBooks() {
    try { return JSON.parse(localStorage.getItem(BOOKS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveBookTitle(title) {
    const t = (title || "").trim();
    if (!t) return;
    const books = loadBooks();
    if (!books.includes(t)) {
      books.unshift(t);
      if (books.length > 80) books.length = 80;
      localStorage.setItem(BOOKS_KEY, JSON.stringify(books));
    }
  }
  function renderBookSuggestions() {
    const books = loadBooks();
    bookSuggestions.innerHTML = books.map(b => `<option value="${escapeHtml(b)}"></option>`).join("");
  }

  // ===== Celebrate =====
  function popSmallFireworks(text) {
    messageEl.textContent = "";
    messageEl.className = "message";
    for (let i = 0; i < 3; i++) {
      const e = document.createElement("span");
      e.classList.add("celebrate-item");
      const item = emojis[Math.floor(Math.random() * emojis.length)];
      e.textContent = item.icon;
      e.style.left = 25 + Math.random() * 50 + "%";
      celebrateArea.appendChild(e);
      setTimeout(() => e.remove(), 900);
    }
    messageEl.innerHTML = `<span class="message-strong">${escapeHtml(text)}</span>`;
  }

  // ===== Solve board storage =====
  function loadSolve() {
    try { return JSON.parse(localStorage.getItem(SOLVE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveSolve(obj) {
    localStorage.setItem(SOLVE_KEY, JSON.stringify(obj));
  }
  function loadSolveBadge() {
    try { return JSON.parse(localStorage.getItem(SOLVE_BADGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveSolveBadge(obj) {
    localStorage.setItem(SOLVE_BADGE_KEY, JSON.stringify(obj));
  }

  function solveEntryFor(date) {
    const all = loadSolve();
    if (!all[date]) all[date] = { vocab: 0, def: 0, syntax: 0 };
    return { all, entry: all[date] };
  }

  function solveTodayCounts() {
    const all = loadSolve();
    const t = todayString();
    const e = all[t] || { vocab:0, def:0, syntax:0 };
    const todayTotal = (e.vocab||0) + (e.def||0) + (e.syntax||0);
    return { t, e, todayTotal, all };
  }

  function solveTotals() {
    const all = loadSolve();
    let total = 0;
    Object.keys(all).forEach(d => {
      const e = all[d] || {};
      total += (e.vocab||0) + (e.def||0) + (e.syntax||0);
    });
    return total;
  }

  function updateSolveView() {
    const { e } = solveTodayCounts();
    const todayTotal = (e.vocab||0) + (e.def||0) + (e.syntax||0);
    const total = solveTotals();
    solveStatsEl.textContent = `ä»Šæ—¥ï¼š${todayTotal}ï¼ˆè¯æ±‡${e.vocab||0}/å®šä¹‰${e.def||0}/å¥æ³•${e.syntax||0}ï¼‰ï½œ ç´¯è®¡ï¼š${total}`;
  }

  function maybeSolveFireworks() {
    const { t, e } = solveTodayCounts();
    const todayTotal = (e.vocab||0) + (e.def||0) + (e.syntax||0);

    if (todayTotal < 5) return;

    const badge = loadSolveBadge();
    if (badge[t]) return; // ä»Šå¤©å·²ç»è§¦å‘è¿‡

    badge[t] = true;
    saveSolveBadge(badge);

    popSmallFireworks("è§£é¢˜ â‰¥ 5 âœ… ä½ ä»Šå¤©è„‘å­å¾ˆæ¸…æ¥šï¼");
  }

  function setSolveCategory(cat) {
    solveCat = cat;
    solveCatVocab.classList.remove("active");
    solveCatDef.classList.remove("active");
    solveCatSyntax.classList.remove("active");
    if (cat === "vocab") solveCatVocab.classList.add("active");
    if (cat === "def") solveCatDef.classList.add("active");
    if (cat === "syntax") solveCatSyntax.classList.add("active");
  }

  // ===== Today tasks helpers =====
  function ensureTodayTasks(modeState) {
    const today = todayString();
    modeState.todayTasks = (modeState.todayTasks || []).filter(t => t && t.date === today);
    if (modeState.todayTasks.length) {
      if (!modeState.activeTaskId || !modeState.todayTasks.some(t => t.id === modeState.activeTaskId)) {
        modeState.activeTaskId = modeState.todayTasks[0].id;
      }
    } else {
      modeState.activeTaskId = null;
    }
  }
  function getActiveTask() {
    const modeState = getModeState(currentMode);
    ensureTodayTasks(modeState);
    return modeState.todayTasks.find(t => t.id === modeState.activeTaskId) || null;
  }
  function renderTaskSelect() {
    const modeState = getModeState(currentMode);
    ensureTodayTasks(modeState);

    taskSelect.innerHTML = "";
    if (!modeState.todayTasks.length) return;

    modeState.todayTasks.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = (t.label && t.label.trim()) ? t.label.trim() : "ï¼ˆæœªå‘½åï¼‰";
      taskSelect.appendChild(opt);
    });

    taskSelect.value = modeState.activeTaskId;

    taskSelect.onchange = () => {
      modeState.activeTaskId = taskSelect.value;
      saveState();
      const active = getActiveTask();
      if (active) updateProgressDisplay(active.finished, active.total, active.label);
    };
  }

  // ===== UI =====
  function applyModeUI() {
    const conf = MODE_CONFIG[currentMode];
    totalLabel.textContent = conf.totalLabel;
    doneBtn.textContent = conf.doneButton;

    if (currentMode === "read") {
      readTitleBlock.classList.remove("hidden");
      writeLabelBlock.classList.add("hidden");
      renderBookSuggestions();
    } else {
      readTitleBlock.classList.add("hidden");
      writeLabelBlock.classList.remove("hidden");
    }
  }
  function updateCurrentLabel(label) {
    const t = (label || "").trim();
    if (t) currentLabelEl.innerHTML = `å½“å‰ï¼š<span>${escapeHtml(t)}</span>`;
    else currentLabelEl.textContent = "";
  }
  function updateProgressDisplay(finished, total, label) {
    const conf = MODE_CONFIG[currentMode];
    finished = Number(finished || 0);
    total = Number(total || 0);

    progressMainText.textContent = total > 0
      ? `å·²å®Œæˆ ${finished} / ${total} ${conf.unit}`
      : `å·²å®Œæˆ 0 / 0 ${conf.unit}`;

    let percentRaw = total > 0 ? (finished / total) * 100 : 0;
    if (!isFinite(percentRaw)) percentRaw = 0;

    const barPercent = Math.max(0, Math.min(percentRaw, 100));
    progressPercentText.textContent = percentRaw <= 100 ? `${Math.round(percentRaw)}%` : `100%+`;
    progressBarInner.style.width = `${barPercent}%`;

    if (percentRaw === 0) statusText.textContent = "æ…¢æ…¢æ¥ï¼Œæ¯ä¸€ç‚¹éƒ½ç®—æ•° âœ¨";
    else if (percentRaw < 40) statusText.textContent = "å·²ç»èµ·æ­¥å•¦ï½";
    else if (percentRaw < 80) statusText.textContent = "å·²ç»è¿‡åŠå•¦ï½";
    else if (percentRaw < 100) statusText.textContent = "å¿«åˆ°ç»ˆç‚¹å•¦ï½";
    else statusText.textContent = "ç›®æ ‡å®Œæˆå•¦ï½ç»§ç»­ä¹Ÿå¯ä»¥ï¼";

    updateCurrentLabel(label);
  }
  function showCelebrate(big) {
    messageEl.textContent = "";
    messageEl.className = "message";

    if (big) {
      for (let i = 0; i < 5; i++) {
        const e = document.createElement("span");
        e.classList.add("celebrate-item");
        const item = emojis[Math.floor(Math.random() * emojis.length)];
        e.textContent = item.icon;
        e.style.left = 20 + Math.random() * 60 + "%";
        celebrateArea.appendChild(e);
        setTimeout(() => e.remove(), 900);
      }
      messageEl.innerHTML = `<span class="message-strong">å®Œæˆç›®æ ‡å•¦ ğŸ‰</span>`;
    } else {
      const emojiSpan = document.createElement("span");
      emojiSpan.classList.add("celebrate-item");
      const item = emojis[Math.floor(Math.random() * emojis.length)];
      emojiSpan.textContent = item.icon;
      celebrateArea.appendChild(emojiSpan);
      setTimeout(() => emojiSpan.remove(), 900);

      const msg = messages[Math.floor(Math.random() * messages.length)];
      messageEl.textContent = `${item.name}ï¼š${msg}`;
    }
  }

  // ===== Core actions =====
  function addTodayTask(total, label) {
    const modeState = getModeState(currentMode);
    ensureTodayTasks(modeState);

    const today = todayString();
    const cleanLabel = (label || "").trim();
    const id = `t-${today}-${Date.now()}-${Math.random().toString(16).slice(2)}`;

    const task = { id, date: today, total: Number(total || 0), finished: 0, label: cleanLabel };

    modeState.todayTasks.push(task);
    modeState.activeTaskId = id;

    // å†å²è¿½åŠ ï¼ˆåŒä¸€å¤©å¤šæ¡ï¼‰
    modeState.history.push({ ...task, id: `h-${id}` });
    if (modeState.history.length > 4000) modeState.history = modeState.history.slice(-4000);

    saveState();
    renderTaskSelect();
    updateHistoryView();

    return task;
  }

  function updateActiveFinished(newFinished) {
    const modeState = getModeState(currentMode);
    ensureTodayTasks(modeState);

    const active = getActiveTask();
    if (!active) return;

    active.finished = Number(newFinished || 0);

    const hid = `h-${active.id}`;
    const idx = modeState.history.findIndex(h => h.id === hid);
    if (idx >= 0) {
      modeState.history[idx].finished = active.finished;
      modeState.history[idx].total = active.total;
      modeState.history[idx].label = active.label || "";
    }

    saveState();
    renderTaskSelect();
    updateHistoryView();
  }

  // ===== History edit =====
  function resetEditor() {
    editingRecordId = null;
    editDate.value = "";
    editBook.value = "";
    editPages.value = "";
    editTotal.value = "";
    editStatus.textContent = "";
  }
  function setEditorFromRecord(rec) {
    editingRecordId = rec.id;
    editDate.value = rec.date || "";
    editBook.value = rec.label || "";
    editPages.value = Number(rec.finished || 0);
    editTotal.value = Number(rec.total || 0);
    editStatus.textContent = `æ­£åœ¨ç¼–è¾‘ï¼š${rec.date || ""} Â· ${rec.label || "ï¼ˆæœªå‘½åï¼‰"}`;
  }
  function upsertReadHistoryRecord() {
    const date = (editDate.value || "").trim();
    if (!date) { alert("è¯·é€‰æ‹©æ—¥æœŸ"); return; }

    const label = (editBook.value || "").trim();
    const finished = Number(editPages.value || 0);
    const total = Number(editTotal.value || 0);

    const readState = getModeState("read");

    if (editingRecordId) {
      const idx = readState.history.findIndex(h => h.id === editingRecordId);
      if (idx >= 0) {
        readState.history[idx].date = date;
        readState.history[idx].label = label;
        readState.history[idx].finished = finished;
        readState.history[idx].total = total;
      } else {
        readState.history.push({
          id: `h-read-${date}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
          date, label, finished, total
        });
      }
      editStatus.textContent = "å·²æ›´æ–° âœ…";
    } else {
      readState.history.push({
        id: `h-read-${date}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
        date, label, finished, total
      });
      editStatus.textContent = "å·²æ–°å¢ âœ…";
    }

    if (label) saveBookTitle(label);

    saveState();
    renderBookSuggestions();
    updateReadingStats();
    updateHistoryView();
  }
  function deleteReadHistoryRecordById(id) {
    const readState = getModeState("read");
    const idx = readState.history.findIndex(h => h.id === id);
    if (idx >= 0) readState.history.splice(idx, 1);

    if (String(id).startsWith("h-t-")) {
      const tid = id.slice(2);
      const tIdx = readState.todayTasks.findIndex(t => t.id === tid);
      if (tIdx >= 0) readState.todayTasks.splice(tIdx, 1);
      if (readState.activeTaskId === tid) readState.activeTaskId = readState.todayTasks[0]?.id || null;
    }

    saveState();
    updateReadingStats();
    updateHistoryView();
    renderTaskSelect();
    if (editingRecordId === id) resetEditor();
  }

  // ===== Recent 7 days =====
  function updateHistoryView() {
    const modeState = getModeState(currentMode);
    const history = modeState.history || [];

    if (!history.length) {
      historyList.textContent = "æš‚æ— æ•°æ®ï½";
      weekSummary.textContent = "";
      updateReadingStats();
      return;
    }

    const today = todayString();
    const thisWeekStart = getWeekStartTime(parseDateStr(today));

    let weekFinished = 0, weekTotal = 0;

    history.forEach(item => {
      if (!item.date) return;
      const ws = getWeekStartTime(parseDateStr(item.date));
      if (ws === thisWeekStart) {
        weekFinished += Number(item.finished || 0);
        weekTotal += Number(item.total || 0);
      }
    });

    const conf = MODE_CONFIG[currentMode];
    weekSummary.textContent = weekTotal > 0
      ? `æœ¬å‘¨åˆè®¡ï¼š${weekFinished}/${weekTotal}${conf.unit}`
      : "æœ¬å‘¨æš‚æœªè®°å½•ä»»åŠ¡";

    const last7 = history.slice(-7).reverse();
    historyList.innerHTML = "";

    last7.forEach(item => {
      const div = document.createElement("div");
      div.classList.add("history-item");
      const percent = item.total > 0 ? Math.round((item.finished / item.total) * 100) : 0;
      const labelText = item.label ? ` Â· ${item.label}` : "";
      div.innerHTML = `
        <span class="history-date">${escapeHtml(item.date || "")}${escapeHtml(labelText)}</span>
        <span class="history-detail">${Number(item.finished||0)}/${Number(item.total||0)}${conf.unit}ï¼ˆ${percent <= 100 ? percent+"%" : "100%+"}ï¼‰</span>
      `;
      historyList.appendChild(div);
    });

    updateReadingStats();
  }

  // ===== Reading stats + RAW + integrate solve =====
  function updateReadingStats() {
    const readState = getModeState("read");
    const history = readState.history || [];

    // --- solve summary always update ---
    updateSolveView();

    // If no reading
    if (!history.length) {
      readingTableContainer.textContent = "æš‚æ— é˜…è¯»è®°å½•ï½";
      bookTableContainer.textContent = "æš‚æ— ä¹¦ç±è®°å½•ï½";
      rawTableContainer.textContent = "æš‚æ— åŸå§‹è®°å½•ï½";
      readingChart.innerHTML = "";
      const solveTotal = solveTotals();
      const { e } = solveTodayCounts();
      const solveToday = (e.vocab||0)+(e.def||0)+(e.syntax||0);
      totalAllEl.textContent = `ç´¯è®¡é˜…è¯»ï¼š0 é¡µ ï½œ ç´¯è®¡å¤©æ•°ï¼š0 å¤© ï½œ å¹³å‡æ¯å¤©ï¼š0.0 é¡µ/å¤© ï½œ è¿ç»­é˜…è¯»ï¼š0 å¤© ï½œ è¿ç»­é¡µæ•°ï¼š0 é¡µ ï½œ ä»Šæ—¥è§£é¢˜ï¼š${solveToday} ï½œ ç´¯è®¡è§£é¢˜ï¼š${solveTotal}`;
      renderRawTable("");
      return;
    }

    // daily reading map
    const dailyMap = new Map(); // date -> { finished, labels:Set }
    history.forEach(item => {
      if (!item.date) return;
      const key = item.date;
      if (!dailyMap.has(key)) dailyMap.set(key, { finished: 0, labels: new Set() });
      const entry = dailyMap.get(key);
      entry.finished += Number(item.finished || 0);
      if (item.label && item.label.trim()) entry.labels.add(item.label.trim());
    });
    const dates = Array.from(dailyMap.keys()).sort();

    const totalAllPages = history.reduce((s, it) => s + Number(it.finished || 0), 0);
    const totalDays = dates.filter(d => (dailyMap.get(d)?.finished || 0) > 0).length;
    const avgPerDay = totalDays > 0 ? (totalAllPages / totalDays) : 0;

    // streak from last recorded day
    let streakDays = 0;
    let streakPages = 0;
    if (dates.length > 0) {
      let cursor = new Date(parseDateStr(dates[dates.length - 1]));
      while (true) {
        const key = cursor.toISOString().slice(0,10);
        const v = (dailyMap.get(key)?.finished) || 0;
        if (v <= 0) break;
        streakDays += 1;
        streakPages += v;
        cursor.setDate(cursor.getDate() - 1);
        if (streakDays > 4000) break;
      }
    }

    // integrate solve totals into main panel
    const solveTotal = solveTotals();
    const { e } = solveTodayCounts();
    const solveToday = (e.vocab||0)+(e.def||0)+(e.syntax||0);

    totalAllEl.textContent =
      `ç´¯è®¡é˜…è¯»ï¼š${totalAllPages} é¡µ ï½œ ç´¯è®¡å¤©æ•°ï¼š${totalDays} å¤© ï½œ å¹³å‡æ¯å¤©ï¼š${avgPerDay.toFixed(1)} é¡µ/å¤© ï½œ è¿ç»­é˜…è¯»ï¼š${streakDays} å¤© ï½œ è¿ç»­é¡µæ•°ï¼š${streakPages} é¡µ ï½œ ä»Šæ—¥è§£é¢˜ï¼š${solveToday} ï½œ ç´¯è®¡è§£é¢˜ï¼š${solveTotal}`;

    // daily table
    let html = '<table class="reading-table"><thead><tr><th>æ—¥æœŸ</th><th>å®Œæˆé¡µæ•°</th><th>ä¹¦å</th></tr></thead><tbody>';
    dates.forEach(d => {
      const entry = dailyMap.get(d);
      const labels = Array.from(entry.labels).join(" / ") || "-";
      html += `<tr><td>${escapeHtml(d)}</td><td>${entry.finished}</td><td>${escapeHtml(labels)}</td></tr>`;
    });
    html += "</tbody></table>";
    readingTableContainer.innerHTML = html;

    // book summary
    const bookMap = new Map();
    history.forEach(item => {
      const book = (item.label || "").trim() || "ï¼ˆæœªå‘½åï¼‰";
      if (!bookMap.has(book)) bookMap.set(book, { pages: 0, days: new Set(), lastDate: item.date || "" });
      const e = bookMap.get(book);
      e.pages += Number(item.finished || 0);
      if (item.date) e.days.add(item.date);
      if (item.date && item.date > e.lastDate) e.lastDate = item.date;
    });
    const books = Array.from(bookMap.entries()).sort((a,b) => b[1].pages - a[1].pages);
    let bhtml = '<table class="reading-table"><thead><tr><th>ä¹¦å</th><th>ç´¯è®¡é¡µæ•°</th><th>å‡ºç°å¤©æ•°</th><th>æœ€è¿‘é˜…è¯»</th></tr></thead><tbody>';
    books.forEach(([name, e]) => {
      bhtml += `<tr><td>${escapeHtml(name)}</td><td>${e.pages}</td><td>${e.days.size}</td><td>${escapeHtml(e.lastDate || "-")}</td></tr>`;
    });
    bhtml += "</tbody></table>";
    bookTableContainer.innerHTML = bhtml;

    // chart
    const recentDates = dates.slice(-90);
    const values = recentDates.map(d => dailyMap.get(d).finished);
    const maxValue = Math.max(...values, 1);
    const maxSqrt = Math.sqrt(maxValue);

    readingChart.innerHTML = "";
    recentDates.forEach((d, idx) => {
      const v = dailyMap.get(d).finished;

      const barWrapper = document.createElement("div");
      barWrapper.classList.add("chart-bar-wrapper");

      const bar = document.createElement("div");
      bar.classList.add("chart-bar");

      const minH = 35;
      const h = v <= 0 ? 6 : Math.max(minH, (Math.sqrt(v) / maxSqrt) * 100);
      bar.style.height = `${h}%`;

      if (streakDays > 0 && idx >= recentDates.length - streakDays) bar.classList.add("streak");

      const label = document.createElement("div");
      label.classList.add("chart-bar-label");
      label.textContent = `${d.slice(5)}\n${v}`;

      barWrapper.appendChild(bar);
      barWrapper.appendChild(label);
      readingChart.appendChild(barWrapper);
    });

    // raw search render
    renderRawTable(rawSearch.value);
  }

  function renderRawTable(keyword) {
    const readState = getModeState("read");
    const history = readState.history || [];
    const k = (keyword || "").trim().toLowerCase();

    const rows = history
      .filter(it => {
        const label = String(it.label || "").toLowerCase();
        const date = String(it.date || "").toLowerCase();
        return !k || label.includes(k) || date.includes(k);
      })
      .slice(-900)
      .reverse();

    let r = '<table class="reading-table"><thead><tr><th>æ—¥æœŸ</th><th>ä¹¦å(label)</th><th>å®Œæˆ</th><th>ç›®æ ‡</th><th>æ“ä½œ</th></tr></thead><tbody>';
    rows.forEach(it => {
      r += `<tr>
        <td>${escapeHtml(it.date || "")}</td>
        <td>${escapeHtml(it.label || "ï¼ˆç©ºï¼‰")}</td>
        <td>${Number(it.finished||0)}</td>
        <td>${Number(it.total||0)}</td>
        <td class="actions">
          <a data-act="edit" data-id="${escapeHtml(it.id)}">ç¼–è¾‘</a>
          <a data-act="del" data-id="${escapeHtml(it.id)}">åˆ é™¤</a>
        </td>
      </tr>`;
    });
    r += "</tbody></table>";
    rawTableContainer.innerHTML = r;

    rawTableContainer.onclick = (e) => {
      const a = e.target.closest("a[data-act]");
      if (!a) return;
      const act = a.getAttribute("data-act");
      const id = a.getAttribute("data-id");
      const rec = readState.history.find(h => h.id === id);
      if (!rec) return;

      if (act === "edit") {
        setEditorFromRecord(rec);
        editDate.scrollIntoView({behavior:"smooth", block:"center"});
      } else if (act === "del") {
        const ok = confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ");
        if (!ok) return;
        deleteReadHistoryRecordById(id);
      }
    };
  }

  // ===== Init =====
  function initFromState() {
    applyModeUI();

    const modeState = getModeState(currentMode);
    ensureTodayTasks(modeState);

    const active = getActiveTask();

    if (modeState.todayTasks.length) {
      setupSection.classList.add("hidden");
      mainSection.classList.remove("hidden");

      renderTaskSelect();

      if (active) {
        totalInput.value = active.total;
        if (currentMode === "read") bookInput.value = active.label || "";
        else labelInput.value = active.label || "";
        updateProgressDisplay(active.finished, active.total, active.label);
      }
    } else {
      setupSection.classList.remove("hidden");
      mainSection.classList.add("hidden");
      totalInput.value = "";
      bookInput.value = "";
      labelInput.value = "";
      progressBarInner.style.width = "0%";
      messageEl.textContent = "";
      currentLabelEl.textContent = "";
    }

    editDate.value = todayString();

    updateSolveView();
    updateHistoryView();
  }

  // ===== Events =====
  modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const mode = btn.getAttribute("data-mode");
      if (mode === currentMode) return;
      currentMode = mode;

      modeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      celebrateArea.innerHTML = "";
      messageEl.textContent = "";

      initFromState();
    });
  });

  startBtn.addEventListener("click", () => {
    const value = parseInt(totalInput.value, 10);
    if (!value || value <= 0) { alert("è¯·è¾“å…¥ä¸€ä¸ªå¤§äº 0 çš„ç›®æ ‡æ•°é‡ã€‚"); return; }

    let label = "";
    if (currentMode === "read") {
      label = (bookInput.value || "").trim();
      saveBookTitle(label);
      renderBookSuggestions();
    } else {
      label = (labelInput.value || "").trim();
    }

    const task = addTodayTask(value, label);
    setupSection.classList.add("hidden");
    mainSection.classList.remove("hidden");
    renderTaskSelect();
    updateProgressDisplay(task.finished, task.total, task.label);
    updateReadingStats();
  });

  addTaskBtn.addEventListener("click", () => {
    totalInput.value = "";
    if (currentMode === "read") { bookInput.value = ""; renderBookSuggestions(); }
    else { labelInput.value = ""; }
    setupSection.classList.remove("hidden");
    mainSection.classList.add("hidden");
  });

  doneBtn.addEventListener("click", () => {
    const active = getActiveTask();
    if (!active) { alert("è¯·å…ˆæ·»åŠ ä¸€ä¸ªä»»åŠ¡~"); return; }

    let finished = Number(active.finished || 0);
    const total = Number(active.total || 0);
    const wasCompleted = total > 0 && finished >= total;

    finished += (currentMode === "read") ? 1 : WRITE_STEP;

    updateActiveFinished(finished);
    updateProgressDisplay(finished, total, active.label);

    const nowCompleted = total > 0 && finished >= total;
    if (!wasCompleted && nowCompleted) showCelebrate(true);
    else showCelebrate(false);

    updateReadingStats();
  });

  saveRecordBtn.addEventListener("click", () => {
    upsertReadHistoryRecord();
  });

  clearEditorBtn.addEventListener("click", () => {
    resetEditor();
    editDate.value = todayString();
  });

  rawSearch.addEventListener("input", () => {
    renderRawTable(rawSearch.value);
  });

  quickGetBtn.addEventListener("click", () => {
    rawSearch.value = "get";
    renderRawTable(rawSearch.value);
  });
  quickGtdBtn.addEventListener("click", () => {
    rawSearch.value = "gtd";
    renderRawTable(rawSearch.value);
  });
  quickOriginBtn.addEventListener("click", () => {
    rawSearch.value = "åŸè‘—é˜…è¯»è¥";
    renderRawTable(rawSearch.value);
  });

  // Solve category buttons
  solveCatVocab.addEventListener("click", () => setSolveCategory("vocab"));
  solveCatDef.addEventListener("click", () => setSolveCategory("def"));
  solveCatSyntax.addEventListener("click", () => setSolveCategory("syntax"));

  // Solve add one
  solveBtn.addEventListener("click", () => {
    const t = todayString();
    const { all, entry } = solveEntryFor(t);
    entry[solveCat] = (entry[solveCat] || 0) + 1;
    all[t] = entry;
    saveSolve(all);

    updateSolveView();
    updateReadingStats();     // åŒæ­¥æ€»é¢æ¿æ•°å­—
    maybeSolveFireworks();    // >=5 å°çƒŸèŠ±
  });

  // ===== Start =====
  initFromState();
</script>
</body>
</html>
