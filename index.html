<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é˜…è¯» & å†™ä½œå°çƒŸèŠ± Â· å¤šæœ¬ä¹¦å¹¶è¡Œç‰ˆï¼ˆç›®æ ‡å¯åŠ  + å›¾è¡¨ä¿®å¤ + è¿ç§»ä¸ä¸¢æ¡£ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", "PingFang SC", sans-serif;
      display: flex;const totalAllPages = history.reduce((sum, item) => sum + Number(item.finished || 0), 0);

// âœ… ç´¯è®¡å¤©æ•°ï¼šæŒ‰â€œæ—¥æœŸæ±‡æ€»åï¼Œå½“å¤©æ€»é¡µæ•° > 0 æ‰ç®—ä¸€å¤©â€
const daysWithReading = new Set();
history.forEach(item => {
  if (Number(item.finished || 0) > 0 && item.date) daysWithReading.add(item.date);
});
const totalDays = daysWithReading.size;
const avgPerDay = totalDays > 0 ? (totalAllPages / totalDays) : 0;

if (totalAllEl) {
  totalAllEl.textContent =
    `ç´¯è®¡é˜…è¯»ï¼š${totalAllPages} é¡µ ï½œ ç´¯è®¡å¤©æ•°ï¼š${totalDays} å¤© ï½œ å¹³å‡æ¯å¤©ï¼š${avgPerDay.toFixed(1)} é¡µ/å¤©`;
}
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #fce4ec, #e3f2fd);
    }
    .card {
      background: #ffffffcc;
      backdrop-filter: blur(8px);
      padding: 20px 22px;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      max-width: 560px;
      width: 94%;
      box-sizing: border-box;
    }
    h1 { font-size: 20px; margin: 0 0 8px; text-align: center; }
    .subtitle { font-size: 13px; color: #666; text-align: center; margin-bottom: 10px; }

    .mode-switch {
      display: flex; gap: 8px; background: #f3e5f5aa; padding: 4px; border-radius: 999px;
      margin: 8px auto 14px; max-width: 280px;
    }
    .mode-btn {
      flex: 1; border-radius: 999px; border: none; padding: 6px 0; font-size: 13px;
      cursor: pointer; background: transparent; color: #555;
      transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, #ff80ab, #7c4dff);
      color: #fff; font-weight: 600; transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(124, 77, 255, 0.35);
    }

    label { font-size: 14px; display: block; margin-bottom: 4px; }
    input[type="number"], input[type="text"], input[type="date"] {
      width: 100%; padding: 7px 9px; border-radius: 8px; border: 1px solid #ccc;
      font-size: 13px; box-sizing: border-box; margin-bottom: 6px;
    }
    .hint { font-size: 11px; color: #888; margin-bottom: 4px; }

    .btn {
      margin-top: 6px; width: 100%; padding: 10px 0; font-size: 15px; border-radius: 999px;
      border: none; cursor: pointer; background: linear-gradient(135deg, #ff80ab, #7c4dff);
      color: white; font-weight: 600; transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s ease;
      box-shadow: 0 6px 15px rgba(124, 77, 255, 0.35);
    }
    .btn:active { transform: translateY(1px) scale(0.99); box-shadow: 0 3px 8px rgba(124, 77, 255, 0.3); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
    .hidden { display: none; }

    .btn-secondary {
      flex: 1; padding: 6px 0; font-size: 11px; border-radius: 999px; border: 1px solid #ddd;
      background: #fafafa; color: #666; cursor: pointer; transition: background 0.1s ease, transform 0.1s ease;
    }
    .btn-secondary:active { background: #f0f0f0; transform: translateY(1px); }
    .btn-secondary.danger { border-color: #ff8a80; color: #d32f2f; background: #fff5f5; }
    .btn-secondary.danger:active { background: #ffe5e5; }
    .secondary-group { display: flex; gap: 6px; margin-top: 8px; }

    .progress-container { margin-top: 14px; }
    .progress-text { font-size: 14px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: baseline; }
    .progress-main { font-weight: 600; }
    .progress-percent { font-size: 12px; color: #666; }
    .progress-bar { width: 100%; height: 10px; border-radius: 999px; background: #eee; overflow: hidden; }
    .progress-bar-inner {
      height: 100%; width: 0%; border-radius: 999px;
      background: linear-gradient(90deg, #ff80ab, #7c4dff);
      transition: width 0.25s ease;
    }
    .status-text { margin-top: 6px; font-size: 13px; color: #555; text-align: center; }
    .current-label { margin-top: 4px; font-size: 12px; color: #777; text-align: center; }
    .current-label span { font-weight: 600; color: #5e35b1; }

    .celebrate-area { position: relative; margin-top: 14px; height: 70px; overflow: visible; }
    .celebrate-item {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      font-size: 30px; pointer-events: none; animation: pop-up 900ms ease-out forwards;
    }
    @keyframes pop-up {
      0% { transform: translate(-50%, -30%) scale(0.4); opacity: 0; }
      40% { transform: translate(-50%, -60%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -110%) scale(0.7); opacity: 0; }
    }
    .message { margin-top: 4px; font-size: 13px; text-align: center; color: #444; min-height: 20px; }
    .message-strong { font-weight: 600; color: #ff4081; }

    .history-section { margin-top: 14px; border-top: 1px dashed #ddd; padding-top: 8px; }
    .history-title { font-size: 12px; color: #777; margin-bottom: 4px; }
    .week-summary { font-size: 11px; color: #555; margin-bottom: 4px; }
    .history-list { font-size: 11px; color: #555; max-height: 90px; overflow-y: auto; }
    .history-item { display: flex; justify-content: space-between; margin-bottom: 2px; }
    .history-date { flex: 0 0 auto; margin-right: 6px; }
    .history-detail { flex: 1; text-align: right; }

    .all-reading-section { margin-top: 14px; border-top: 1px dashed #ddd; padding-top: 8px; }
    .all-reading-title { font-size: 12px; color: #777; margin-bottom: 4px; }
    .all-reading-table {
      max-height: 140px; overflow-y: auto; border-radius: 8px; background: #fafafa;
      padding: 6px; box-sizing: border-box; margin-bottom: 8px;
    }
    table.reading-table { width: 100%; border-collapse: collapse; font-size: 11px; color: #555; }
    table.reading-table th, table.reading-table td {
      padding: 2px 4px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap;
    }
    table.reading-table th { font-weight: 600; color: #666; }

    .chart-container { margin-top: 4px; }
    .chart-note { font-size: 11px; color: #777; margin-bottom: 4px; }
    .chart{
  height: 220px;     /* âœ… å¿…é¡»æœ‰æ˜ç¡®é«˜åº¦ */
  display: flex;
  align-items: flex-end;
  overflow-x: auto;
  gap: 10px;
  padding: 8px 6px 10px;
}

.chart-bar-wrapper{
  flex: 0 0 32px;           /* æŸ±å­å®½ */
  height: 100%;             /* âœ… å…³é”®ï¼šè®©æŸ±å­çš„ç™¾åˆ†æ¯”é«˜åº¦æœ‰å‚ç…§ */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end; /* âœ… å…³é”®ï¼šä»åº•éƒ¨å¾€ä¸Šé•¿ */
}

.chart-bar{
  max-width: 32px;     /* æŸ±å­æ›´ç²— */
  min-height: 6px;     /* 0é¡µä¹Ÿå¯è§ */
}
    .chart-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; min-width: 16px; }
    .chart-bar {
      width: 100%; max-width: 20px; border-radius: 999px 999px 0 0;
      background: linear-gradient(135deg, #ff80ab, #7c4dff);
      transition: height 0.2s ease;
      min-height: 2px; /* âœ… å…³é”®ï¼šå³ä½¿æ˜¯0é¡µä¹Ÿä¸ä¼šå®Œå…¨â€œç©ºç™½çœ‹ä¸è§â€ */
    }
/* streak é«˜äº®ï¼šä¸æ”¹é¢œè‰²ï¼ŒåªåŠ ç²— + æè¾¹ + è½»å¾®é˜´å½± */
.chart-bar.streak {
  outline: 2px solid rgba(0,0,0,0.35);
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

.chart-bar-wrapper.streak {
  transform: scaleY(1.02);
}
    .chart-bar-label { margin-top: 2px; font-size: 9px; color: #777; text-align: center; transform: scale(0.9); white-space: pre; }

    .manual-section { margin-top: 10px; border-top: 1px dashed #eee; padding-top: 6px; }
    .manual-title { font-size: 11px; color: #777; margin-bottom: 4px; }
    .manual-row { display: flex; gap: 6px; margin-bottom: 6px; }
    .manual-row .col { flex: 1; }
    .manual-btn {
      width: 100%; padding: 6px 0; font-size: 11px; border-radius: 999px;
      border: 1px solid #ddd; background: #f5f5ff; color: #5e35b1; cursor: pointer;
      transition: background 0.1s ease, transform 0.1s ease;
    }
    .manual-btn:active { background: #e8e0ff; transform: translateY(1px); }

    .multi-title { font-size: 12px; color: #777; margin-bottom: 6px; }
    .multi-box { background: #fafafa; border-radius: 12px; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; }
    .task-row { display: grid; grid-template-columns: 1.3fr 0.7fr 1fr; gap: 6px; }
    .task-actions { display: flex; gap: 6px; margin-top: 6px; }
    .mini-btn {
      flex: 1;
      padding: 7px 0;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color: #555;
      cursor: pointer;
    }
    .mini-btn.primary {
      border: none;
      background: linear-gradient(135deg, #ff80ab, #7c4dff);
      color: #fff;
    }
    .mini-btn:active { transform: translateY(1px); }
    .task-list { margin-top: 8px; display: grid; gap: 6px; }
    .task-item {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #eee;
      padding: 10px;
    }
    .task-head {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .task-name { font-weight: 700; font-size: 13px; color: #333; }
    .task-meta { font-size: 11px; color: #777; }
    .task-progressline { display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-bottom: 6px; }
    .task-bar { height: 8px; border-radius: 999px; background: #eee; overflow: hidden; }
    .task-bar-inner {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #ff80ab, #7c4dff);
    }
    .task-ops { display: flex; gap: 6px; margin-top: 8px; }
    .task-ops button { flex: 1; }

    .footer-tip { margin-top: 8px; font-size: 11px; text-align: center; color: #999; }

    @media (max-width: 480px) {
      .card { padding: 16px 16px; border-radius: 16px; }
      h1 { font-size: 18px; }
      .subtitle { font-size: 12px; }
      .task-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ¦Š é˜…è¯» & å†™ä½œå°çƒŸèŠ±</h1>
    <div class="subtitle">It hurts but it builds up.</div>

    <div class="mode-switch">
      <button class="mode-btn active" data-mode="read">ğŸ“– é˜…è¯»æ¨¡å¼</button>
      <button class="mode-btn" data-mode="write">âœï¸ å†™ä½œæ¨¡å¼</button>
    </div>

    <div id="setup-section">
      <div id="multi-setup" class="multi-box">
        <div class="multi-title">ğŸ“š ä»Šæ—¥å¤šæœ¬ä¹¦ä»»åŠ¡ï¼ˆå¯åŒæ—¶è¯»ä¸¤æœ¬/å¤šæœ¬ï¼‰</div>
        <div class="task-row">
          <div>
            <label for="book-input">ä¹¦å / ä»»åŠ¡å</label>
            <input type="text" id="book-input" placeholder="ä¾‹å¦‚ï¼šNaval è‹±æ–‡ / è®ºæ–‡èµ„æ–™ / å°è¯´ã€ŠXXXã€‹" />
          </div>
          <div>
            <label for="book-pages-input">ç›®æ ‡é¡µæ•°</label>
            <input type="number" id="book-pages-input" min="1" placeholder="30" />
          </div>
          <div>
            <label for="book-label-input">æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="book-label-input" placeholder="Naval è‹±æ–‡ / è®ºæ–‡ / å°è¯´é˜…è¯»â€¦" />
          </div>
        </div>
        <div class="task-actions">
          <button class="mini-btn primary" id="add-book-btn">æ·»åŠ è¿™æœ¬ä¹¦</button>
          <button class="mini-btn" id="clear-today-books-btn">æ¸…ç©ºä»Šæ—¥ä¹¦å•</button>
        </div>

        <div class="hint">å¼€å§‹åä¹Ÿå¯ä»¥ç»§ç»­æ·»åŠ æ–°ä¹¦ï¼›åŒä¸€æœ¬ä¹¦å¦‚æœè¯»ä¸¤æ®µï¼Œå¯ç”¨â€œç›®æ ‡+é¡µâ€ã€‚</div>
        <div class="task-list" id="today-book-list-setup"></div>
      </div>

      <div id="write-setup" class="hidden">
        <label id="total-label" for="total-input">ä»Šå¤©æ‰“ç®—å†™å¤šå°‘å­—ï¼Ÿ</label>
        <input type="number" id="total-input" min="1" placeholder="ä¾‹å¦‚ï¼š800" />
        <label for="label-input">è¿™ä¸ªä»»åŠ¡å±äºå“ªä¸ªé¡¹ç›®ï¼Ÿ</label>
        <div class="hint">ä¾‹å¦‚ï¼šè®ºæ–‡ / è¯¾ç¨‹ä½œä¸š / è‹±æ–‡å†™ä½œï¼ˆå¯ç•™ç©ºï¼‰</div>
        <input type="text" id="label-input" placeholder="å¯ç•™ç©ºï¼Œä¸å¡«ä¹Ÿå¯ä»¥" />
      </div>

      <button class="btn" id="start-btn">å¼€å§‹ä»Šå¤©çš„ä»»åŠ¡</button>
    </div>

    <div id="main-section" class="hidden">
      <div id="single-progress-area" class="progress-container hidden">
        <div class="progress-text">
          <div class="progress-main" id="progress-main-text">å·²å®Œæˆ 0 / 0</div>
          <div class="progress-percent" id="progress-percent-text">0%</div>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progress-bar-inner"></div>
        </div>
        <div class="status-text" id="status-text">æ…¢æ…¢æ¥ï¼Œæ¯ä¸€ç‚¹éƒ½ç®—æ•° âœ¨</div>
        <div class="current-label" id="current-label"></div>
        <button class="btn" id="done-btn">å†å†™ä¸€ç‚¹ âœ…</button>
      </div>

      <div id="multi-progress-area" class="hidden">
        <div class="history-title">ğŸ“Œ ä»Šæ—¥ä¹¦å•ï¼ˆæ¯æœ¬ä¹¦ç‹¬ç«‹è®¡æ•° + å¯è¿½åŠ ç›®æ ‡ï¼‰</div>
        <div class="task-list" id="today-book-list-main"></div>
        <div class="hint">æ’¤é”€ä¼šæ’¤é”€â€œä½ æœ€è¿‘ä¸€æ¬¡ç‚¹è¿‡çš„é‚£æœ¬ä¹¦â€ã€‚</div>
      </div>

      <div class="secondary-group">
        <button class="btn-secondary" id="undo-btn">æ’¤é”€ä¸€æ­¥ â¤º</button>
        <button class="btn-secondary" id="reset-today-btn">é‡ç½®ä»Šå¤©</button>
        <button class="btn-secondary danger" id="clear-all-btn">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      </div>

      <div class="celebrate-area" id="celebrate-area"></div>
      <div class="message" id="message"></div>

      <div class="history-section">
        <div class="history-title">æœ€è¿‘ 7 å¤©ï¼ˆå½“å‰æ¨¡å¼ï¼‰</div>
        <div class="week-summary" id="week-summary"></div>
        <div class="history-list" id="history-list"></div>
      </div>

      <div class="all-reading-section" id="all-reading-section">
      <div class="all-reading-title">ğŸ“Š é˜…è¯»æ¨¡å¼ - å†å²ç»Ÿè®¡ï¼ˆè‡ªä½¿ç”¨æœ¬å·¥å…·ä»¥æ¥ï¼‰</div>
      <div class="hint" id="reading-total-all" style="margin:4px 0 8px;">
      ç´¯è®¡é˜…è¯»ï¼š0 é¡µ
      </div>
        <div class="all-reading-table" id="reading-table-container"></div>
        <div class="chart-container">
          <div class="chart-note">æœ€è¿‘ 30 å¤©æ¯å¤©æ€»é¡µæ•°ï¼ˆ0é¡µä¹Ÿä¼šæ˜¾ç¤ºç»†æŸ±ï¼Œä¸ä¼šç©ºç™½ï¼‰</div>
          <div class="chart" id="reading-chart"></div>
        </div>

        <div class="manual-section">
          <div class="manual-title">âœ‹ æ‰‹åŠ¨æ·»åŠ ä¸€æ¡é˜…è¯»è®°å½•ï¼ˆè¡¥æ˜¨å¤© / ä¹‹å‰çš„é˜…è¯»ï¼‰</div>

          <div class="manual-row">
            <div class="col">
              <label for="manual-date">æ—¥æœŸ</label>
              <input type="date" id="manual-date" />
            </div>
            <div class="col">
              <label for="manual-title">ä¹¦å/ä»»åŠ¡åï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="manual-title" placeholder="ä¾‹å¦‚ï¼šNaval è‹±æ–‡ / å°è¯´ã€ŠXXXã€‹" />
            </div>
          </div>

          <div class="manual-row">
            <div class="col">
              <label for="manual-pages">å®Œæˆé¡µæ•°</label>
              <input type="number" id="manual-pages" min="1" placeholder="ä¾‹å¦‚ï¼š25" />
            </div>
            <div class="col">
              <label for="manual-label">æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="manual-label" placeholder="Naval è‹±æ–‡ / è®ºæ–‡ / å°è¯´é˜…è¯»â€¦" />
            </div>
          </div>

          <button class="manual-btn" id="manual-add-btn">æ·»åŠ é˜…è¯»è®°å½•</button>
          <div class="hint">è¡¥å½•ä¼šè®¡å…¥å†å²ä¸æŸ±çŠ¶å›¾ï¼›åŒä¸€å¤©åŒä¸€æœ¬ä¹¦ä¼šåˆå¹¶ã€‚</div>
        </div>
      </div>

      <div class="footer-tip">æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨é‡Œï¼Œæ¢ä»£ç ä¹Ÿä¸ä¼šä¸¢ï¼ˆæœ¬ç‰ˆæ”¯æŒè‡ªåŠ¨è¿ç§»æ—§æ•°æ®ï¼‰ï½</div>
    </div>
  </div>

  <script>
    // ========= DOM =========
    const modeButtons = document.querySelectorAll(".mode-btn");
    const setupSection = document.getElementById("setup-section");
    const mainSection = document.getElementById("main-section");

    const writeSetup = document.getElementById("write-setup");
    const totalInput = document.getElementById("total-input");
    const labelInput = document.getElementById("label-input");

    const multiSetup = document.getElementById("multi-setup");
    const bookInput = document.getElementById("book-input");
    const bookPagesInput = document.getElementById("book-pages-input");
    const bookLabelInput = document.getElementById("book-label-input");
    const addBookBtn = document.getElementById("add-book-btn");
    const clearTodayBooksBtn = document.getElementById("clear-today-books-btn");
    const todayBookListSetup = document.getElementById("today-book-list-setup");

    const singleProgressArea = document.getElementById("single-progress-area");
    const multiProgressArea = document.getElementById("multi-progress-area");

    const progressMainText = document.getElementById("progress-main-text");
    const progressPercentText = document.getElementById("progress-percent-text");
    const progressBarInner = document.getElementById("progress-bar-inner");
    const statusText = document.getElementById("status-text");
    const currentLabelEl = document.getElementById("current-label");
    const doneBtn = document.getElementById("done-btn");

    const todayBookListMain = document.getElementById("today-book-list-main");

    const startBtn = document.getElementById("start-btn");
    const undoBtn = document.getElementById("undo-btn");
    const resetTodayBtn = document.getElementById("reset-today-btn");
    const clearAllBtn = document.getElementById("clear-all-btn");
    const celebrateArea = document.getElementById("celebrate-area");
    const messageEl = document.getElementById("message");
    const historyList = document.getElementById("history-list");
    const weekSummary = document.getElementById("week-summary");

    const allReadingSection = document.getElementById("all-reading-section");
    const readingTableContainer = document.getElementById("reading-table-container");
    const readingChart = document.getElementById("reading-chart");

    const manualDateInput = document.getElementById("manual-date");
    const manualTitleInput = document.getElementById("manual-title");
    const manualPagesInput = document.getElementById("manual-pages");
    const manualLabelInput = document.getElementById("manual-label");
    const manualAddBtn = document.getElementById("manual-add-btn");

    // ========= IMPORTANT: STORAGE KEY (ä¸è¦ä¹±æ”¹ï¼Œå¦åˆ™â€œçœ‹èµ·æ¥åƒä¸¢æ¡£â€) =========
    // âœ… ä½ æ”¹ä»£ç ä¹Ÿä¿ç•™å†å²çš„å…³é”®ï¼šä¿æŒåŒä¸€ä¸ª key
    const STORAGE_KEY = "tinyRewardTracker_multi_read_v1";

    // âœ… è‡ªåŠ¨è¿ç§»ï¼šä»ä½ æ—§ç‰ˆæœ¬/æ›´æ—§ç‰ˆæœ¬é‡Œè¯»æ•°æ®å¹¶åˆå¹¶
    const LEGACY_KEYS = [
      "tinyRewardTracker_v3_addon",      // ä½ ä¹‹å‰å•ä»»åŠ¡ç‰ˆæœ¬
      "tinyRewardTracker_multi_read_v1"  // ä»¥é˜²ä½ ä¹‹å‰ç”¨è¿‡åŒåï¼ˆè¿™é‡Œé‡å¤ä¹Ÿæ— å®³ï¼‰
    ];

    let currentMode = "read";

    const MODE_CONFIG = {
      read: { name: "é˜…è¯»", unit: "é¡µ" },
      write: { name: "å†™ä½œ", unit: "å­—" }
    };

    const emojis = [
      { icon: "ğŸ¦Š", name: "å°ç‹ç‹¸" },
      { icon: "ğŸ±", name: "å°çŒ«å’ª" },
      { icon: "ğŸ»", name: "å°ç†Š" },
      { icon: "ğŸ°", name: "å°å…”å­" },
      { icon: "ğŸ¼", name: "ç†ŠçŒ«" },
      { icon: "ğŸ‰", name: "çƒŸèŠ±" },
      { icon: "ğŸˆ", name: "æ°”çƒ" },
      { icon: "âœ¨", name: "æ˜Ÿå…‰" },
      { icon: "ğŸŒˆ", name: "å½©è™¹" }
    ];

    // 100æ¡é¼“åŠ±è¯­ï¼ˆç²¾ç®€å†™æ³•ï¼šç›´æ¥å¤ç”¨ä½ ä¹‹å‰é‚£ä»½ï¼‰
    const messages = [
      "It hurts but it builds up.","ä½ å·²ç»ä¸æ˜¯åŸåœ°è¸æ­¥çš„äººäº†ã€‚","å†åšæŒä¸€ä¸‹ï¼Œå°±æ¯”æ˜¨å¤©çš„è‡ªå·±æ›´å¼ºä¸€ç‚¹ã€‚","è¯»å’Œå†™ï¼Œæœ¬æ¥å°±æ˜¯ä½ çš„ superpowerã€‚","ä½ åœ¨ä¸ºæœªæ¥çš„è‡ªå·±é“ºè·¯ã€‚","æ…¢æ…¢æ¥ï¼Œä½†æ°¸è¿œåœ¨è·¯ä¸Šã€‚","ä»Šå¤©ä¹Ÿåœ¨ä¸ºè‡ªç”±äººç”Ÿ +1ã€‚","æ­¤åˆ»çš„ä¸“æ³¨ï¼Œä¼šåœ¨æœªæ¥æŸå¤©çªç„¶å›æŠ¥ä½ ã€‚","ä½ ç¿»è¿‡çš„æ¯ä¸€é¡µï¼Œéƒ½æ˜¯åœ¨ç¿»å¼€ä¸€ä¸ªæ›´å¤§çš„ä¸–ç•Œã€‚","åˆ«äººå¯èƒ½åœ¨åˆ·æ‰‹æœºï¼Œè€Œä½ åœ¨å‡çº§å¤§è„‘ã€‚",
      "ä½ ä¸æ˜¯åœ¨å®Œæˆä»»åŠ¡ï¼Œè€Œæ˜¯åœ¨é›•åˆ»è‡ªå·±çš„æ€è€ƒåŠ›ã€‚","èƒ½åä¸‹æ¥è¯»ä¹¦çš„ä½ ï¼Œå·²ç»èµ¢è¿‡å¾ˆå¤šçŠ¹è±«ä¸å†³çš„æ—¶åˆ»äº†ã€‚","å°±ç®—åªå‰è¿›äº†ä¸€å°æ­¥ï¼Œä¹Ÿæ¯”åœåœ¨åŸåœ°å¥½å¤šäº†ã€‚","ä½ æ­£åœ¨æˆä¸ºé‚£ä¸ªå°æ—¶å€™è‡ªå·±ä¼šè§‰å¾—å¾ˆé…·çš„å¤§äººã€‚","æ‰€æœ‰è¿™äº›çœ‹ä¼¼å®‰é™çš„åŠªåŠ›ï¼Œéƒ½ä¼šæ±‡èšæˆå¾ˆå“äº®çš„ç”Ÿæ´»ã€‚","ä½ å¹¶ä¸éœ€è¦ä¸€ä¸‹å­å¾ˆå‰å®³ï¼Œåªè¦ä¸€ç›´åœ¨å˜å‰å®³ã€‚","ä½ ç°åœ¨è¯»çš„æ¯ä¸€é¡µï¼Œéƒ½åœ¨ç»™æœªæ¥çš„è‡ªå·±æ’‘è…°ã€‚","æ­¤åˆ»çš„ä½ ï¼Œå…¶å®å·²ç»å¾ˆå‹‡æ•¢äº†ã€‚","åˆ«äººå¯èƒ½çœ‹ä¸è§ä½ åœ¨åŠªåŠ›ï¼Œä½†ä½ è‡ªå·±çŸ¥é“å°±å¤Ÿäº†ã€‚","ä½ ä¸æ˜¯åœ¨â€œç†¬â€ï¼Œä½ æ˜¯åœ¨â€œç”Ÿé•¿â€ã€‚",
      "ä½ æ„Ÿåˆ°éš¾ï¼Œæ˜¯å› ä¸ºä½ çœŸçš„åœ¨æŒ‘æˆ˜è‡ªå·±ã€‚","ä¹¦é¡µåœ¨ç¿»åŠ¨ï¼Œä½ çš„äººç”Ÿè„šæœ¬ä¹Ÿåœ¨å·å·æ”¹å†™ã€‚","ä½ æŠŠæ—¶é—´æŠ•ç»™äº†é˜…è¯»ï¼Œæ—¶é—´å°±ä¼šå›æŠ¥ä½ ä»¥ç†è§£åŠ›ã€‚","ä¸€ç‚¹ç‚¹é˜…è¯»ï¼Œä¹Ÿæ˜¯ä¸€ç§æ¸©æŸ”è€Œåšå®šçš„åæŠ—ã€‚","ä½ å¯ä»¥ä¼‘æ¯ï¼Œä½†ä½ ä»æœªæ”¾å¼ƒï¼Œè¿™å°±å¾ˆäº†ä¸èµ·ã€‚","å¤§è„‘æ­£åœ¨ä¸ºä½ æ‚„æ‚„æ­å»ºæ–°çš„â€œæ€ç»´è‚Œè‚‰â€ã€‚","ä½ æ­£åœ¨è®­ç»ƒè‡ªå·±ï¼šå¯ä»¥ä¸é‚£ä¹ˆæ€¥ï¼Œä¹Ÿä¸é‚£ä¹ˆæ…Œã€‚","ä½ ä¸éœ€è¦å’Œä»»ä½•äººæ¯”ï¼Œåªè¦æ¯”æ˜¨å¤©çš„è‡ªå·±è½»å¾®è¿›æ­¥ä¸€ç‚¹ç‚¹ã€‚","ä»Šå¤©çš„è¿™äº›é¡µæ•°ï¼Œä¼šåœ¨æŸä¸ªå…³é”®æ—¶åˆ»å¸®ä½ æ’‘èµ·ä¸€æ•´æ®µæ€è€ƒã€‚","ä½ æ„¿æ„è¯»ä¸‹å»ï¼Œæœ¬èº«å°±æ˜¯å¯¹è‡ªå·±çš„ä¸€ç§æ¸©æŸ”ä¿æŠ¤ã€‚",
      "ä½ åœ¨è®¤çœŸç”Ÿæ´»ï¼Œè€Œä¸æ˜¯è¢«ç”Ÿæ´»æ¨ç€èµ°ã€‚","æ¯ä¸€é¡µéƒ½æ˜¯åœ¨ç»™è‡ªå·±çš„çµé­‚åŠ ä¸€ç‚¹é…è‰²ã€‚","ä½ å¹¶ä¸æ‡’ï¼Œä½ åªæ˜¯éœ€è¦ä¸€ç‚¹ç‚¹è¢«çœ‹è§ï¼Œè€Œæˆ‘çœ‹è§ä½ äº†ã€‚","ä½ æ­£åœ¨æ…¢æ…¢ç§¯ç´¯å±äºè‡ªå·±çš„ã€ä¸å¯æ›¿ä»£çš„è§†è§’ã€‚","ä¸–ç•Œæœ‰ç‚¹åµï¼Œä½†ä½ åœ¨ä¸ºè‡ªå·±ç•™å‡ºä¸€å°å—å®‰é™çš„åœ°æ–¹ã€‚","å³ä¾¿ä»Šå¤©çŠ¶æ€ä¸€èˆ¬ï¼Œä½ ä¾ç„¶æ¥äº†ï¼Œè¿™å·²ç»å¾ˆäº†ä¸èµ·ã€‚","ä½ ç°åœ¨åšçš„äº‹æƒ…ï¼Œå¾ˆå¯èƒ½æ˜¯åå¹´åçš„ä½ ä¼šæ„Ÿè°¢çš„é‚£ç§ã€‚","ä½ å¯¹çŸ¥è¯†çš„æ¸©æŸ”åšæŒï¼Œä¼šå˜æˆå¯¹è‡ªå·±çš„åšå®šä¿¡ä»»ã€‚","ä½ ç°åœ¨ç§ä¸‹çš„æ˜¯ç†è§£åŠ›ï¼Œè€Œä¸æ˜¯å•çº¯çš„â€œé¡µæ•°â€ã€‚","ä½ è‚¯åœä¸‹åˆ·æ‰‹æœºå»è¯»ä¹¦ï¼Œè¿™å·²ç»æ˜¯ç½•è§çš„æ¸©æŸ”å†³å¿ƒã€‚",
      "ä¸æ˜¯ä½ æœ‰å¤šè‡ªå¾‹ï¼Œè€Œæ˜¯ä½ çœŸçš„åœ¨ä¹è‡ªå·±çš„æˆé•¿ã€‚","ä½ å…è®¸è‡ªå·±ç¬¨æ‹™åœ°å‰è¿›ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆé«˜çº§çš„å‹‡æ°”ã€‚","ä»Šå¤©è¿™å‡ é¡µï¼Œçœ‹ä¼¼å¾®å°ï¼Œå´åœ¨æ…¢æ…¢æ”¹å˜ä½ çš„å¤§æ–¹å‘ã€‚","ä½ æ¯è¯»ä¸€å¥ï¼Œä¸–ç•Œå°±æ¯”ä¸€åˆ†é’Ÿå‰å¤šäº†ä¸€ç‚¹ç‚¹ä¸ä¸€æ ·ã€‚","ä½ æ²¡æœ‰è¢«ç„¦è™‘æ¨ç€è·‘ï¼Œè€Œæ˜¯åœ¨ä¸»åŠ¨è¿ˆæ­¥ã€‚","å½“ä½ é€‰æ‹©è¯»ä¹¦ï¼Œä½ å·²ç»åœ¨å¯¹æŠ—â€œè¢«åŠ¨è¿‡æ—¥å­â€çš„å‘½è¿ã€‚","ä½ ä¸æ€¥ï¼Œä½†ä½ ä»ä¸åœæ­¢ï¼Œè¿™å¾ˆå¼ºå¤§ã€‚","ä½ æ­£åœ¨ç»ƒä¹ ä¸è‡ªå·±å¾…åœ¨ä¸€èµ·ï¼Œè€Œä¸æ˜¯é€ƒç¦»è‡ªå·±ã€‚","æ„Ÿåˆ°ç´¯è¯´æ˜ä½ åœ¨ç”¨åŠ›ç”Ÿæ´»ï¼Œè€Œä¸æ˜¯éšæ³¢é€æµã€‚","å¤§è„‘æ­¤åˆ»ä¸€å®šåœ¨å·å·å¯¹ä½ è¯´ï¼šè°¢è°¢ä½ è¿˜åœ¨å–‚å…»æˆ‘ã€‚",
      "ä½ æ¯”è‡ªå·±ä»¥ä¸ºçš„è¦åšå®šå¾—å¤šã€‚","ä½ åœ¨ç”¨æ—¶é—´ï¼Œè®¤çœŸåœ°å–œæ¬¢ä¸Šä¸€ä¸ªæ›´æ‰å®çš„è‡ªå·±ã€‚","è¿™ä¸€é¡µç¿»å®Œï¼Œä½ å¯¹ä¸–ç•Œçš„ç†è§£åˆå¤šäº†ä¸€å±‚æ»¤é•œã€‚","å½“ä¸‹çš„ä½ ï¼Œæ­£åœ¨ä¸ºæœªæ¥çš„ä»å®¹æ‰“åœ°åŸºã€‚","ä½ å¯ä»¥è´¨ç–‘ä¸€åˆ‡ï¼Œä½†ä½ ä»ä¸è´¨ç–‘è‡ªå·±ç»§ç»­å­¦ä¹ çš„æƒåˆ©ã€‚","æ¯ä¸€æ¬¡ç‚¹â€œå®Œæˆâ€ï¼Œéƒ½æ˜¯åœ¨å‘Šè¯‰è‡ªå·±ï¼šæˆ‘åšå¾—åˆ°ã€‚","ä½ ç»™äº†è‡ªå·±ä¸€ä¸ªä¸è¢«æ‰“æ‰°çš„å­¦ä¹ å°å®‡å®™ã€‚","åˆ«äººçœ‹ä¸è§çš„ç« èŠ‚ï¼Œä¼šåœ¨ä¸ä¹…ä¹‹åæ˜¾ç°æˆä½ çš„åº•æ°”ã€‚","ä½ ä¸æ˜¯â€œå¿…é¡»â€è¯»ä¹¦ï¼Œè€Œæ˜¯ä½ â€œé€‰æ‹©â€ç»§ç»­è¯»ä¹¦ã€‚","ä½ æ­£åœ¨ç”¨çŸ¥è¯†æ›¿æ¢ä¸€éƒ¨åˆ†ææƒ§å’Œæ— åŠ›æ„Ÿã€‚",
      "ä½ æ„¿æ„åœä¸‹æ¥æƒ³ä¸€æƒ³ï¼Œè€Œä¸æ˜¯åŒ†å¿™è·¯è¿‡ï¼Œè¿™æ˜¯å¾ˆæ¸©æŸ”çš„åŠ›é‡ã€‚","ä½ åœ¨ç¼è¡¥æ›¾ç»é‚£äº›è§‰å¾—è‡ªå·±ä¸å¤Ÿå¥½çš„åœ°æ–¹ã€‚","ä½ ä¸€é¡µä¸€é¡µåœ°èµ°è¿œï¼Œè€Œä¸æ˜¯ä¸€åˆ·ä¸€åˆ·åœ°ç©ºè½¬ã€‚","ä½ å¯¹è‡ªå·±çš„è€å¿ƒï¼Œä¼šæˆä¸ºä½ ä»¥åå¯¹ä¸–ç•Œçš„åº•æ°”ã€‚","ä½ æ²¡æœ‰æ”¾å¼ƒç†è§£è¿™ä¸ªä¸–ç•Œï¼Œä¹Ÿæ²¡æœ‰æ”¾å¼ƒç†è§£è‡ªå·±ã€‚","ä½ å…è®¸è‡ªå·±æ…¢æ…¢æ¥ï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€ç§æˆç†Ÿã€‚","æ­¤åˆ»ä¹Ÿè®¸æœ‰ç‚¹è¾›è‹¦ï¼Œä½†è¿™æ˜¯ä½ è‡ªå·±é€‰æ‹©çš„è¾›è‹¦ã€‚","ä½ æ²¡æœ‰è¢«â€œç®—äº†å§â€çš„å£°éŸ³å¸¦èµ°ï¼Œè€Œæ˜¯ç•™ä¸‹æ¥å†çœ‹ä¸€é¡µã€‚","ä½ åœ¨ç»™è‡ªå·±çš„ç”Ÿæ´»å¢åŠ å±‚æ¬¡æ„Ÿï¼Œè€Œä¸æ˜¯åªåœç•™åœ¨è¡¨é¢ã€‚","ä½ å¯ä»¥å®³æ€•ï¼Œä½†ä½ ä»ç„¶åœ¨å‰è¿›ï¼Œè¿™å°±å¤Ÿäº†ã€‚",
      "ä½ ä¸æ˜¯ä¸ºäº†æˆç»©åœ¨è¯»ï¼Œè€Œæ˜¯åœ¨ä¸ºè‡ªå·±çš„äººç”Ÿæ‰“è¡¥ä¸ã€‚","æ¯ä¸€æ¬¡ä¸“æ³¨ï¼Œéƒ½æ˜¯åœ¨ä¿®å¤è¢«ç¢ç‰‡åŒ–å¤ºèµ°çš„æ³¨æ„åŠ›ã€‚","ä½ ç»™äº†è‡ªå·±çš„å¤§è„‘ä¸€ä¸ªè¢«è®¤çœŸå¯¹å¾…çš„æœºä¼šã€‚","ä½ åœ¨è®¤çœŸå¯¹å¾…é‚£äº›æ›¾ç»è¢«å¿½ç•¥çš„å¥½å¥‡å¿ƒã€‚","ä½ å¯¹ä¸–ç•Œçš„ç†è§£å·²ç»å’Œä¸€å¹´å‰ã€ä¸€ä¸ªæœˆå‰ä¸ä¸€æ ·äº†ã€‚","ä½ ä¸æ˜¯â€œæ—¶é—´ä¸å¤Ÿâ€ï¼Œä½ æ˜¯åœ¨ä¸»åŠ¨ä¸ºé˜…è¯»æŒ¤å‡ºç©ºé—´ã€‚","è¿™ä¸æ˜¯å°äº‹ï¼Œè¿™æ˜¯ä½ äººç”Ÿçš„æ ¸å¿ƒå·¥ç¨‹ä¹‹ä¸€ã€‚","ä½ æ­£åœ¨æ‚„æ‚„å®Œæˆä»¥å‰çš„ä½ ä¸æ•¢æƒ³è±¡çš„äº‹æƒ…ã€‚","ä½ ç°åœ¨çš„ä¸“æ³¨ï¼Œæ¯”ä½ æƒ³è±¡ä¸­æ›´åŠ çè´µã€‚","ä½ æœ‰æƒåˆ©èŠ±æ—¶é—´åœ¨è‡ªå·±èº«ä¸Šï¼Œè¿™ä¸€ç‚¹æ¯‹åº¸ç½®ç–‘ã€‚",
      "ä½ é è¿‘ä¹¦æœ¬çš„æ ·å­ï¼Œæœ¬èº«å°±å¸¦ç€ä¸€ç‚¹ç‚¹å…‰ã€‚","ä½ ç°åœ¨çš„æ¯ä¸€é¡µï¼Œéƒ½å¯èƒ½æˆä¸ºä½ æ—¥åå†™ä½œçš„ç´ æã€‚","ä½ ä¸æ˜¯æµªè´¹æ—¶é—´ï¼Œä½ æ˜¯åœ¨æ…¢æ…¢æ‰æ ¹ã€‚","ä½ æ²¡æœ‰ç«‹åˆ»çœ‹åˆ°ç»“æœï¼Œä½†è¿‡ç¨‹å·²ç»åœ¨å·å·å¡‘é€ ä½ ã€‚","ä½ åœ¨ç»ƒä¹ å¯¹çŸ¥è¯†ä¿æŒå¥½å¥‡ï¼Œè€Œä¸æ˜¯å†·æ¼ éº»æœ¨ã€‚","ä½ åœ¨ä¸ºæœªæ¥çš„è‡ªç”±ï¼Œæ‚„æ‚„å­˜é’±â€”â€”åªä¸è¿‡å­˜çš„æ˜¯è„‘åŠ›ã€‚","å°±ç®—çŠ¶æ€ä¸å®Œç¾ï¼Œä½ ä¹Ÿç»™äº†è‡ªå·±ä¸€ä¸ªèµ·æ­¥ï¼Œè¿™å¾ˆéš¾å¾—ã€‚","ä½ å·²ç»èµ°å‡ºäº†â€œä»€ä¹ˆéƒ½ä¸åšâ€çš„é‚£é“é—¨æ§›ã€‚","ä½ åœ¨ä¸ºé‚£ä¸ªæ›´ä»å®¹ã€æ›´æŸ”è½¯ä¹Ÿæ›´æœ‰åŠ›é‡çš„è‡ªå·±æ‰“åŸºç¡€ã€‚","ä½ èƒ½åä¸‹æ¥å­¦ä¹ ï¼Œå°±æ˜¯åœ¨æ¸©æŸ”åœ°å’Œç„¦è™‘ä¿æŒè·ç¦»ã€‚",
      "ä½ ä¸€æ­¥æ­¥èµ°å¾—å¾ˆè¸å®ï¼Œå³ä¾¿å¤–ç•ŒèŠ‚å¥å†å¿«ã€‚","ä½ ç»™è‡ªå·±ç•™äº†ä¸€æ¡ä¸è¢«ä»–äººæ”¯é…çš„æˆé•¿é“è·¯ã€‚","ä½ æ²¡æœ‰åœ¨ç”¨â€œç®—äº†â€ç»“æŸä»Šå¤©ï¼Œè€Œæ˜¯åœ¨ç”¨â€œå†çœ‹ä¸€ç‚¹ç‚¹â€å»¶é•¿è‡ªå·±ã€‚","ä½ æ¯ä¸€æ¬¡æŒ‰ä¸‹å®Œæˆï¼Œéƒ½æ˜¯åœ¨å¯¹æ— åŠ›æ„Ÿè¯´ï¼šæˆ‘è¿˜æ˜¯åšåˆ°äº†ã€‚","ä½ æ­£åœ¨å˜æˆä¸€ä¸ªå¯ä»¥ä¿¡ä»»è‡ªå·±çš„å¤§äººã€‚","ä½ æ­£åœ¨ä¸€ç‚¹ç‚¹å…‘ç°ï¼šæˆ‘ä¼šå¥½å¥½å¯¹å¾…è‡ªå·±è¿™å¥è¯ã€‚","ä½ ä¸æ˜¯å­¤ç‹¬åœ°è¯»ä¹¦ï¼Œä½ æ˜¯åœ¨å’Œå¾ˆå¤šæ€æƒ³ä¸€èµ·å¼€ä¼šã€‚","ä½ æ„¿æ„æŠ•å…¥æ³¨æ„åŠ›ï¼Œæœ¬èº«å°±æ˜¯ä¸€ç§äº†ä¸èµ·çš„çˆ±è‡ªå·±æ–¹å¼ã€‚","ä½ åœ¨å®‰é™åœ°ä¸ºæœªæ¥çš„é€‰æ‹©ï¼Œå¢åŠ æ›´å¤šå¤‡é€‰ç­”æ¡ˆã€‚","ä½ å¯¹ä¸–ç•Œçš„é—®é¢˜å¹¶æ²¡æœ‰å˜å°‘ï¼Œä½†ä½ åœ¨æ…¢æ…¢æŒæ¡æé—®å’Œæ€è€ƒçš„æ–¹æ³•ã€‚","ä½ åœ¨æŠŠâ€œæˆ‘ä¸è¡Œå§â€æ‚„æ‚„æ”¹å†™æˆâ€œæˆ‘å¯ä»¥è¯•è¯•çœ‹â€ã€‚","æ¯ä¸€é¡µéƒ½æ˜¯ä½ å’Œè¿™ä¸ªä¸–ç•Œä¹‹é—´çš„ä¸€æ¬¡å°å¯¹è¯ã€‚","ä½ æ²¡æœ‰è¢«ä»Šå¤©çš„æƒ…ç»ªå®Œå…¨æ”¯é…ï¼Œä½ è¿˜ä¿ç•™äº†ä¸€ç‚¹ä¸»åŠ¨æƒã€‚","ä½ æ­¤åˆ»ååœ¨è¿™é‡Œï¼Œå°±æ˜¯åœ¨ä¸ºè‡ªå·±çš„äººç”Ÿè®¤çœŸæŠ•ç¥¨ã€‚"
    ];

    const WRITE_STEP = 100;

    // ========= UTIL =========
    function todayString() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function yesterdayString() {
      const d = new Date(); d.setDate(d.getDate() - 1);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function parseDateStr(s) { const [y,m,d] = s.split("-").map(Number); return new Date(y, m-1, d); }
    function getWeekStartTime(date) {
      const d = new Date(date); d.setHours(0,0,0,0);
      const day = (d.getDay() + 6) % 7; d.setDate(d.getDate() - day);
      return d.getTime();
    }
    function uid() { return Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(2); }
    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ========= STATE LOADING + MIGRATION =========
    function safeParse(raw) { try { return JSON.parse(raw); } catch { return null; } }

    function normalizeState(obj) {
      const base = { read: { today: null, history: [] }, write: { today: null, history: [] } };
      if (!obj || typeof obj !== "object") return base;

      if (!obj.read) obj.read = { today: null, history: [] };
      if (!obj.write) obj.write = { today: null, history: [] };
      if (!Array.isArray(obj.read.history)) obj.read.history = [];
      if (!Array.isArray(obj.write.history)) obj.write.history = [];

      // å…¼å®¹æ—§å•ä»»åŠ¡é˜…è¯» today: {date,total,finished,label}
      if (obj.read.today && obj.read.today.total !== undefined && !obj.read.today.tasks) {
        const t = obj.read.today;
        obj.read.today = {
          date: t.date,
          tasks: [{
            id: uid(),
            title: (t.label && t.label.trim()) ? t.label.trim() : "é˜…è¯»ä»»åŠ¡",
            total: Number(t.total || 0),
            finished: Number(t.finished || 0),
            label: (t.label || "").trim(),
          }],
          lastTouchedTaskId: null
        };
      }

      // å…¼å®¹å¤šä»»åŠ¡ç»“æ„ç¼ºå­—æ®µ
      if (obj.read.today && obj.read.today.tasks && Array.isArray(obj.read.today.tasks)) {
        obj.read.today.tasks = obj.read.today.tasks.map(t => ({
          id: t.id || uid(),
          title: (t.title || "æœªå‘½å").trim(),
          total: Number(t.total || 0),
          finished: Number(t.finished || 0),
          label: (t.label || "").trim(),
        }));
        if (!obj.read.today.lastTouchedTaskId) obj.read.today.lastTouchedTaskId = null;
      }

      // å…¼å®¹å†å²å­—æ®µï¼šå…è®¸ title ç¼ºå¤±
      obj.read.history = obj.read.history.map(h => ({
        date: h.date,
        total: Number(h.total || 0),
        finished: Number(h.finished || 0),
        label: (h.label || "").trim(),
        title: (h.title || "").trim()
      }));
      obj.write.history = obj.write.history.map(h => ({
        date: h.date,
        total: Number(h.total || 0),
        finished: Number(h.finished || 0),
        label: (h.label || "").trim(),
        title: (h.title || "").trim()
      }));

      return obj;
    }

    function mergeHistories(target, incoming) {
      // é˜…è¯»ï¼šæŒ‰ date+title åˆå¹¶ï¼ˆæ— titleå½’ä¸º""ï¼‰
      const mapKey = (h) => `${h.date}__${(h.title||"").trim()}`;
      const seen = new Map();
      (target.read.history || []).forEach(h => seen.set(mapKey(h), h));

      (incoming.read.history || []).forEach(h => {
        const k = mapKey(h);
        if (!seen.has(k)) {
          target.read.history.push({ ...h });
          seen.set(k, h);
        } else {
          // åˆå¹¶ç­–ç•¥ï¼šå–æ›´å¤§çš„å®Œæˆ/ç›®æ ‡ï¼Œæ ‡ç­¾æ‹¼æ¥å»é‡ï¼ˆå°½é‡ä¸è¦†ç›–ä½ çš„æ–°æ•°æ®ï¼‰
          const ex = seen.get(k);
          ex.total = Math.max(ex.total || 0, h.total || 0);
          ex.finished = Math.max(ex.finished || 0, h.finished || 0);
          const labels = new Set(
            [ex.label, h.label].filter(Boolean).join(" / ").split(" / ").map(s => s.trim()).filter(Boolean)
          );
          ex.label = Array.from(labels).join(" / ");
        }
      });

      // å†™ä½œï¼šæŒ‰ date åˆå¹¶
      const wMap = new Map();
      (target.write.history || []).forEach(h => wMap.set(h.date, h));
      (incoming.write.history || []).forEach(h => {
        if (!wMap.has(h.date)) {
          target.write.history.push({ ...h });
          wMap.set(h.date, h);
        } else {
          const ex = wMap.get(h.date);
          ex.total = Math.max(ex.total || 0, h.total || 0);
          ex.finished = Math.max(ex.finished || 0, h.finished || 0);
          const labels = new Set(
            [ex.label, h.label].filter(Boolean).join(" / ").split(" / ").map(s => s.trim()).filter(Boolean)
          );
          ex.label = Array.from(labels).join(" / ");
        }
      });

      // æ’åºï¼ˆæŒ‰æ—¥æœŸï¼‰
      target.read.history.sort((a,b) => a.date.localeCompare(b.date));
      target.write.history.sort((a,b) => a.date.localeCompare(b.date));
      return target;
    }

    function loadState() {
      // å…ˆè¯»å½“å‰ key
      const raw = localStorage.getItem(STORAGE_KEY);
      let current = normalizeState(safeParse(raw));

      // å†å°è¯•ä»æ—§ key è¿ç§»å¹¶åˆå¹¶
      LEGACY_KEYS.forEach(k => {
        if (k === STORAGE_KEY) return;
        const legacyRaw = localStorage.getItem(k);
        if (!legacyRaw) return;
        const legacy = normalizeState(safeParse(legacyRaw));
        current = mergeHistories(current, legacy);
      });

      // é™åˆ¶é•¿åº¦ï¼ˆé˜²æ­¢æ— é™å¢é•¿ï¼‰
      if (current.read.history.length > 4000) current.read.history = current.read.history.slice(-4000);
      if (current.write.history.length > 2000) current.write.history = current.write.history.slice(-2000);

      // ä¿å­˜ä¸€æ¬¡ï¼Œç¡®ä¿è¿ç§»è½ç›˜
      localStorage.setItem(STORAGE_KEY, JSON.stringify(current));
      return current;
    }

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function getModeState(mode) {
      if (!state[mode]) state[mode] = { today: null, history: [] };
      return state[mode];
    }

    // ========= STATE =========
    let state = loadState();

    // ========= CELEBRATE =========
    function showCelebrate(big) {
      messageEl.textContent = "";
      if (big) {
        for (let i = 0; i < 5; i++) {
          const e = document.createElement("span");
          e.classList.add("celebrate-item");
          const item = emojis[Math.floor(Math.random() * emojis.length)];
          e.textContent = item.icon;
          e.style.left = 20 + Math.random() * 60 + "%";
          celebrateArea.appendChild(e);
          setTimeout(() => e.remove(), 900);
        }
        messageEl.innerHTML = `<span class="message-strong">å®Œæˆç›®æ ‡å•¦ï¼ä½ çœŸçš„å¾ˆå‰å®³ ğŸ‰</span>`;
      } else {
        const emojiSpan = document.createElement("span");
        emojiSpan.classList.add("celebrate-item");
        const item = emojis[Math.floor(Math.random() * emojis.length)];
        emojiSpan.textContent = item.icon;
        celebrateArea.appendChild(emojiSpan);
        setTimeout(() => emojiSpan.remove(), 900);
        const msg = messages[Math.floor(Math.random() * messages.length)];
        messageEl.textContent = `${item.name}ï¼š${msg}`;
      }
    }

    // ========= MODE UI =========
    function setModeUI() {
      if (currentMode === "read") {
        multiSetup.classList.remove("hidden");
        writeSetup.classList.add("hidden");
      } else {
        multiSetup.classList.add("hidden");
        writeSetup.classList.remove("hidden");
      }
    }

    // ========= READ MULTI TASKS =========
    function ensureReadToday() {
      const readState = getModeState("read");
      const totalAllEl = document.getElementById("reading-total-all");
      const today = todayString();
      if (!readState.today || readState.today.date !== today) {
        readState.today = { date: today, tasks: [], lastTouchedTaskId: null };
      }
      if (!Array.isArray(readState.today.tasks)) readState.today.tasks = [];
      return readState.today;
    }

    function upsertReadHistoryForTodayTask(task) {
      const readState = getModeState("read");
      const totalAllEl = document.getElementById("reading-total-all");
      const today = todayString();
      const title = (task.title || "").trim();
      const label = (task.label || "").trim();
      const idx = readState.history.findIndex(h => h.date === today && (h.title || "").trim() === title);
      if (idx >= 0) {
        readState.history[idx].finished = Number(task.finished || 0);
        readState.history[idx].total = Number(task.total || 0);
        readState.history[idx].label = label;
      } else {
        readState.history.push({ date: today, finished: Number(task.finished||0), total: Number(task.total||0), label, title });
      }
      readState.history.sort((a,b) => a.date.localeCompare(b.date));
      if (readState.history.length > 4000) readState.history = readState.history.slice(-4000);
    }

    function addTodayTask(title, total, label) {
      const todayObj = ensureReadToday();
      const cleanTitle = (title || "").trim() || "æœªå‘½å";
      const cleanLabel = (label || "").trim();
      const task = { id: uid(), title: cleanTitle, total: Number(total), finished: 0, label: cleanLabel };
      todayObj.tasks.push(task);
      todayObj.lastTouchedTaskId = task.id;
      saveState();
      refreshReadUI();
    }

    function removeTodayTask(taskId) {
      if (!confirm("ç¡®å®šåˆ é™¤è¿™æœ¬ä¹¦çš„ä»Šæ—¥ä»»åŠ¡å—ï¼Ÿï¼ˆä¸ä¼šåˆ å†å²è®°å½•ï¼Œåªåˆ ä»Šå¤©åˆ—è¡¨ï¼‰")) return;
      const readState = getModeState("read");
      const today = todayString();
      if (!readState.today || readState.today.date !== today) return;
      readState.today.tasks = (readState.today.tasks || []).filter(t => t.id !== taskId);
      if (readState.today.lastTouchedTaskId === taskId) readState.today.lastTouchedTaskId = null;
      saveState();
      refreshReadUI();
    }

    function addTargetToTask(taskId, delta) {
      const readState = getModeState("read");
      const today = todayString();
      if (!readState.today || readState.today.date !== today) {
        alert("è¯·å…ˆå¼€å§‹ä»Šå¤©çš„ä»»åŠ¡~");
        return;
      }
      const task = (readState.today.tasks || []).find(t => t.id === taskId);
      if (!task) return;
      const add = Number(delta || 0);
      if (!add || add <= 0) return;

      task.total = Number(task.total || 0) + add;
      readState.today.lastTouchedTaskId = task.id;

      // åŒæ­¥åˆ°å†å²ï¼ˆå½“å¤©è¯¥ä¹¦çš„ç›®æ ‡å˜æ›´ï¼‰
      upsertReadHistoryForTodayTask(task);

      saveState();
      refreshReadUI();
      messageEl.textContent = `å·²ç»™ã€Š${task.title}ã€‹ç›®æ ‡ +${add} é¡µ âœ…`;
    }

    function addOnePageToTask(taskId) {
      const readState = getModeState("read");
      const today = todayString();
      if (!readState.today || readState.today.date !== today) {
        alert("è¯·å…ˆå¼€å§‹ä»Šå¤©çš„ä»»åŠ¡~");
        return;
      }
      const task = (readState.today.tasks || []).find(t => t.id === taskId);
      if (!task) return;

      const wasCompleted = (task.total > 0) && (task.finished >= task.total);

      task.finished = Number(task.finished || 0) + 1;
      readState.today.lastTouchedTaskId = task.id;

      upsertReadHistoryForTodayTask(task);

      saveState();
      refreshReadUI();

      const nowCompleted = (task.total > 0) && (task.finished >= task.total);
      if (!wasCompleted && nowCompleted) showCelebrate(true);
      else showCelebrate(false);
    }

    function clearTodayBookList() {
      if (!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©ä¹¦å•å—ï¼Ÿï¼ˆåªæ¸…ä»Šå¤©ä»»åŠ¡ï¼Œä¸å½±å“å†å²ï¼‰")) return;
      const readState = getModeState("read");
      const today = todayString();
      readState.today = { date: today, tasks: [], lastTouchedTaskId: null };
      saveState();
      refreshReadUI();
    }

    // ========= RENDER TASKS =========
    function renderTodayBooks(listEl, tasks, mode) {
      listEl.innerHTML = "";
      if (!tasks || tasks.length === 0) {
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = (mode === "setup")
          ? "ä»Šå¤©è¿˜æ²¡æ·»åŠ ä¹¦ï½å…ˆæ·»åŠ ä¸€æœ¬å§ã€‚"
          : "ä»Šå¤©è¿˜æ²¡æ·»åŠ ä¹¦ï½å›åˆ°ä¸Šæ–¹è®¾å®šåŒºæ·»åŠ ã€‚";
        listEl.appendChild(div);
        return;
      }

      tasks.forEach(t => {
        const percentRaw = t.total > 0 ? (t.finished / t.total) * 100 : 0;
        const barPercent = Math.max(0, Math.min(percentRaw, 100));
        const percentText = percentRaw <= 100 ? `${Math.round(percentRaw)}%` : `100%+`;

        const item = document.createElement("div");
        item.className = "task-item";

        const labelText = (t.label && t.label.trim()) ? ` Â· ${t.label.trim()}` : "";
        item.innerHTML = `
          <div class="task-head">
            <div class="task-name">${escapeHtml(t.title || "æœªå‘½å")}</div>
            <div class="task-meta">${t.finished}/${t.total} é¡µï¼ˆ${percentText}ï¼‰</div>
          </div>
          <div class="task-progressline">
            <div>${escapeHtml(labelText)}</div>
            <div>${t.finished >= t.total ? "âœ… å·²è¾¾æ ‡" : "â³ è¿›è¡Œä¸­"}</div>
          </div>
          <div class="task-bar"><div class="task-bar-inner" style="width:${barPercent}%"></div></div>
        `;

        const ops = document.createElement("div");
        ops.className = "task-ops";

        if (mode === "main") {
          const plus = document.createElement("button");
          plus.className = "mini-btn primary";
          plus.textContent = "+1 é¡µ âœ…";
          plus.addEventListener("click", () => addOnePageToTask(t.id));

          // âœ… æ–°å¢ï¼šç›®æ ‡åŠ é¡µæŒ‰é’®
          const add5 = document.createElement("button");
          add5.className = "mini-btn";
          add5.textContent = "ç›®æ ‡ +5";
          add5.addEventListener("click", () => addTargetToTask(t.id, 5));

          const add10 = document.createElement("button");
          add10.className = "mini-btn";
          add10.textContent = "ç›®æ ‡ +10";
          add10.addEventListener("click", () => addTargetToTask(t.id, 10));

          const custom = document.createElement("button");
          custom.className = "mini-btn";
          custom.textContent = "è‡ªå®šä¹‰ +";
          custom.addEventListener("click", () => {
            const v = prompt("ç»™è¿™æœ¬ä¹¦ç›®æ ‡åŠ å¤šå°‘é¡µï¼Ÿï¼ˆè¯·è¾“å…¥æ­£æ•´æ•°ï¼‰", "10");
            if (v === null) return;
            const n = parseInt(v, 10);
            if (!n || n <= 0) { alert("è¯·è¾“å…¥æ­£æ•´æ•°ï½"); return; }
            addTargetToTask(t.id, n);
          });

          const remove = document.createElement("button");
          remove.className = "mini-btn";
          remove.textContent = "åˆ é™¤æœ¬ä¹¦";
          remove.addEventListener("click", () => removeTodayTask(t.id));

          // æ’åˆ—ï¼š+1ã€ç›®æ ‡+ã€åˆ ä¹¦
          ops.appendChild(plus);
          ops.appendChild(add5);
          ops.appendChild(add10);
          ops.appendChild(custom);
          ops.appendChild(remove);
        } else {
          const remove = document.createElement("button");
          remove.className = "mini-btn";
          remove.textContent = "åˆ é™¤";
          remove.addEventListener("click", () => removeTodayTask(t.id));
          ops.appendChild(remove);
        }

        item.appendChild(ops);
        listEl.appendChild(item);
      });
    }

    function refreshReadUI() {
      const readToday = ensureReadToday();
      renderTodayBooks(todayBookListSetup, readToday.tasks, "setup");
      renderTodayBooks(todayBookListMain, readToday.tasks, "main");
      updateHistoryView();
    }

    // ========= WRITE =========
    function setWriteTodayTask(total, label) {
      const writeState = getModeState("write");
      const today = todayString();
      const cleanLabel = (label || "").trim();
      writeState.today = { date: today, total: Number(total), finished: 0, label: cleanLabel };

      const idx = writeState.history.findIndex(h => h.date === today);
      const entry = { date: today, total: Number(total), finished: 0, label: cleanLabel, title: "" };
      if (idx >= 0) writeState.history[idx] = entry;
      else writeState.history.push(entry);

      writeState.history.sort((a,b) => a.date.localeCompare(b.date));
      if (writeState.history.length > 2000) writeState.history = writeState.history.slice(-2000);

      saveState();
      updateHistoryView();
    }

    function updateWriteTodayFinished(newFinished) {
      const writeState = getModeState("write");
      const today = todayString();
      if (!writeState.today || writeState.today.date !== today) return;
      writeState.today.finished = Number(newFinished || 0);

      const idx = writeState.history.findIndex(h => h.date === today);
      if (idx >= 0) {
        writeState.history[idx].finished = writeState.today.finished;
        writeState.history[idx].total = writeState.today.total;
        writeState.history[idx].label = writeState.today.label || "";
      } else {
        writeState.history.push({
          date: today,
          total: writeState.today.total,
          finished: writeState.today.finished,
          label: writeState.today.label || "",
          title: ""
        });
      }
      saveState();
      updateHistoryView();
    }

    function updateWriteProgressDisplay(finished, total, label) {
      finished = finished || 0;
      total = total || 0;
      progressMainText.textContent = `å·²å®Œæˆ ${finished} / ${total} å­—`;

      let percentRaw = total > 0 ? (finished / total) * 100 : 0;
      if (!isFinite(percentRaw)) percentRaw = 0;
      const barPercent = Math.max(0, Math.min(percentRaw, 100));
      const percentDisplay = percentRaw <= 100 ? `${Math.round(percentRaw)}%` : `100%+`;

      progressPercentText.textContent = percentDisplay;
      progressBarInner.style.width = `${barPercent}%`;

      if (percentRaw === 0) statusText.innerHTML = "æ…¢æ…¢æ¥ï¼Œæ¯ä¸€ç‚¹éƒ½ç®—æ•° âœ¨";
      else if (percentRaw < 40) statusText.innerHTML = "å·²ç»èµ·æ­¥å•¦ï¼Œç»§ç»­ä¿æŒï½";
      else if (percentRaw < 80) statusText.innerHTML = "å·²ç»è¿‡åŠå•¦ï¼Œçœ‹å¾—å‡ºä½ çœŸçš„åœ¨åŠªåŠ› âœï¸";
      else if (percentRaw < 100) statusText.innerHTML = "å¿«åˆ°ç»ˆç‚¹å•¦ï¼Œå†åšæŒä¸€ä¸‹ï¼";
      else if (percentRaw < 150) statusText.innerHTML = "ç›®æ ‡å®Œæˆå•¦ï¼Œåé¢éƒ½æ˜¯ç”œç”œçš„åŠ é¤ ğŸ‚";
      else statusText.innerHTML = "è¶…é¢å¾ˆå¤šäº†ï¼Œä»Šå¤©çœŸçš„å¾ˆå‰å®³ï¼ğŸ”¥";

      if (label && label.trim()) currentLabelEl.innerHTML = `å½“å‰é¡¹ç›®ï¼š<span>${escapeHtml(label.trim())}</span>`;
      else currentLabelEl.textContent = "";
    }

    // ========= HISTORY + STATS =========
    function updateHistoryView() {
      const modeState = getModeState(currentMode);
      const history = modeState.history || [];
      if (!history.length) {
        historyList.textContent = "æš‚æ— æ•°æ®ï¼Œå…ˆå®Œæˆä¸€æ¬¡ä»»åŠ¡è¯•è¯•ï½";
        weekSummary.textContent = "";
        updateReadingStats();
        return;
      }

      const today = todayString();
      const thisWeekStart = getWeekStartTime(parseDateStr(today));

      let weekFinished = 0;
      let weekTotal = 0;
      history.forEach(item => {
        const ws = getWeekStartTime(parseDateStr(item.date));
        if (ws === thisWeekStart) {
          weekFinished += item.finished || 0;
          weekTotal += item.total || 0;
        }
      });

      const unit = MODE_CONFIG[currentMode].unit;
      if (weekTotal > 0) {
        const percent = Math.round((weekFinished / weekTotal) * 100);
        weekSummary.textContent = `æœ¬å‘¨åˆè®¡ï¼š${weekFinished}/${weekTotal}${unit}ï¼ˆçº¦ ${percent}%ï¼‰`;
      } else {
        weekSummary.textContent = "æœ¬å‘¨æš‚æœªè®°å½•ä»»åŠ¡";
      }

      const last7 = history.slice(-7).reverse();
      historyList.innerHTML = "";
      last7.forEach(item => {
        const div = document.createElement("div");
        div.classList.add("history-item");
        const percent = item.total > 0 ? Math.round((item.finished / item.total) * 100) : 0;
        const percentText = percent <= 100 ? `${percent}%` : `${percent}%+`;
        const labelText = item.label ? ` Â· ${item.label}` : "";
        const titleText = item.title ? `ã€Š${item.title}ã€‹` : "";
        div.innerHTML = `
          <span class="history-date">${item.date} ${escapeHtml(titleText)}${escapeHtml(labelText)}</span>
          <span class="history-detail">${item.finished}/${item.total}${unit}ï¼ˆ${percentText}ï¼‰</span>
        `;
        historyList.appendChild(div);
      });

      updateReadingStats();
    }

    // âœ… ä¿®å¤â€œæŸ±çŠ¶å›¾ä¸æ˜¾ç¤ºâ€ï¼šæ— å†å²æç¤º / 0é¡µä¹Ÿç”»ç»†æŸ±
   function updateReadingStats() {
  // åªåœ¨é˜…è¯»æ¨¡å¼æ˜¾ç¤º
  const allReadingSection = document.getElementById("all-reading-section");
  const readingTableContainer = document.getElementById("reading-table-container");
  const readingChart = document.getElementById("reading-chart");
  const totalAllEl = document.getElementById("reading-total-all");

  if (!allReadingSection || !readingTableContainer || !readingChart) {
    // é¡µé¢é‡Œç¼ºç»„ä»¶ï¼šç›´æ¥è¿”å›ï¼Œé¿å…æŠ¥é”™å¯¼è‡´æ•´é¡µä¸æ¸²æŸ“
    return;
  }

  if (currentMode !== "read") {
    allReadingSection.style.display = "none";
    return;
  }
  allReadingSection.style.display = "block";

  const readState = getModeState("read");
  const history = (readState && readState.history) ? readState.history : [];

  // ç´¯è®¡æ€»é¡µæ•°ï¼ˆæ‰€æœ‰è®°å½•ï¼‰
  const totalAllPages = history.reduce((sum, item) => sum + Number(item.finished || 0), 0);
  if (totalAllEl) totalAllEl.textContent = `ç´¯è®¡é˜…è¯»ï¼š${totalAllPages} é¡µ`;

  if (!history.length) {
    readingTableContainer.textContent = "æš‚æ— é˜…è¯»è®°å½•ï½";
    readingChart.innerHTML = "<div class='hint'>æš‚æ— æ•°æ®ï¼Œå®Œæˆä¸€æ¬¡é˜…è¯»åè¿™é‡Œä¼šå‡ºç°æŸ±çŠ¶å›¾ã€‚</div>";
    return;
  }

  // æŒ‰å¤©æ±‡æ€»ï¼šdate -> { finished, titles:Set, labels:Set }
  const dailyMap = new Map();
  history.forEach(item => {
    const key = item.date;
    if (!key) return;

    if (!dailyMap.has(key)) {
      dailyMap.set(key, { finished: 0, titles: new Set(), labels: new Set() });
    }
    const entry = dailyMap.get(key);
    entry.finished += Number(item.finished || 0);
    if (item.title && String(item.title).trim()) entry.titles.add(String(item.title).trim());
    if (item.label && String(item.label).trim()) entry.labels.add(String(item.label).trim());
  });

  const dates = Array.from(dailyMap.keys()).sort();
  if (!dates.length) {
    readingTableContainer.textContent = "æš‚æ— å¯ç”¨æ•°æ®ï½";
    readingChart.innerHTML = "<div class='hint'>æš‚æ— å¯å±•ç¤ºçš„æ—¥æœŸã€‚</div>";
    return;
  }

  // è¡¨æ ¼
  let html =
    '<table class="reading-table"><thead><tr><th>æ—¥æœŸ</th><th>æ€»é¡µæ•°</th><th>ä¹¦å/æ ‡ç­¾</th></tr></thead><tbody>';
  dates.forEach(d => {
    const entry = dailyMap.get(d);
    const titles = Array.from(entry.titles).join(" / ") || "-";
    const labels = Array.from(entry.labels).join(" / ");
    const mix = labels ? `${titles} Â· ${labels}` : titles;

    html += `<tr><td>${d}</td><td>${entry.finished}</td><td>${escapeHtml(mix)}</td></tr>`;
  });
  html += "</tbody></table>";
  readingTableContainer.innerHTML = html;

  // æŸ±çŠ¶å›¾ï¼šæœ€è¿‘30å¤©
  // ===== æŸ±çŠ¶å›¾ï¼šæœ€è¿‘ N å¤©ï¼ˆæ›´é•¿æ›´æœ‰æ¿€åŠ±ï¼‰=====
const DAYS_TO_SHOW = 90; // ä½ å¯ä»¥æ”¹æˆ 60 / 90 / 120
const recentDates = dates.slice(-DAYS_TO_SHOW);

// è®¡ç®— streakï¼šä»æœ€è¿‘ä¸€å¤©å¾€å›è¿ç»­ï¼ˆå½“å¤©æ€»é¡µæ•°>0æ‰ç®—ï¼‰
const setRecent = new Set(recentDates);
let streak = 0;
if (recentDates.length > 0) {
  let cursor = new Date(parseDateStr(recentDates[recentDates.length - 1]));
  while (true) {
    const y = cursor.getFullYear();
    const m = String(cursor.getMonth() + 1).padStart(2, "0");
    const dd = String(cursor.getDate()).padStart(2, "0");
    const key = `${y}-${m}-${dd}`;

    if (!setRecent.has(key)) break; // å›¾é‡Œæ²¡æœ‰è¿™å¤©ï¼ˆè¯´æ˜å¤ªä¹…ä»¥å‰ï¼‰
    const v = (dailyMap.get(key)?.finished) || 0;
    if (v <= 0) break;              // æ–­äº†
    streak += 1;
    cursor.setDate(cursor.getDate() - 1);
  }
}

// âœ… æŠŠ streak æ•°å­—æ˜¾ç¤ºå‡ºæ¥ï¼ˆä½ ä¹‹å‰çš„ç»Ÿè®¡åŒº idï¼šreading-total-allï¼‰
if (totalAllEl) {
  // è¿™é‡Œä¸è¦†ç›–ä½ ä¸Šé¢ç´¯è®¡/å¹³å‡é‚£æ®µæ–‡å­—çš„è¯ï¼Œå°±è¿½åŠ  streak
  // å¦‚æœä½ å·²ç»è®¾ç½®äº† totalAllEl.textContentï¼Œå°±ç”¨ä¸‹é¢è¿™è¡Œâ€œè¿½åŠ â€
  totalAllEl.textContent = `${totalAllEl.textContent} ï½œ è¿ç»­é˜…è¯»ï¼š${streak} å¤©`;
}

// âœ… éçº¿æ€§é«˜åº¦ï¼šè®© 5 é¡µä¹Ÿâ€œçœ‹èµ·æ¥å¾ˆé«˜â€
// ç”¨ sqrtï¼šå°æ•°å€¼è¢«æŠ¬é«˜ã€æå¤§å€¼ä¸ä¼šå¤¸å¼ åˆ°å‹æ‰å…¶ä»–æŸ±
const values = recentDates.map(d => (dailyMap.get(d)?.finished) || 0);
const maxValue = Math.max(...values, 1);
const maxSqrt = Math.sqrt(maxValue);

readingChart.innerHTML = "";

recentDates.forEach((d, idx) => {
  const v = (dailyMap.get(d)?.finished) || 0;

  const barWrapper = document.createElement("div");
  barWrapper.classList.add("chart-bar-wrapper");

  const bar = document.createElement("div");
  bar.classList.add("chart-bar");

  // âœ… é«˜åº¦å…¬å¼ï¼ˆå…³é”®ï¼‰
  // 1) v=0 â†’ ç»™ä¸€ä¸ªå¾ˆä½ä½†å¯è§çš„é«˜åº¦ï¼ˆé¿å…ç©ºï¼‰
  // 2) v=5 â†’ sqrt(5)â‰ˆ2.236ï¼Œä¼šè¢«æ˜æ˜¾æŠ¬é«˜
  // 3) é«˜å€¼ä¹Ÿä¸ä¼šæŠŠå…¶ä»–æŸ±å‹æ‰
  const minH = 10; // æœ€å°é«˜åº¦ï¼ˆè®©ä½å€¼ä¹Ÿâ€œæœ‰å­˜åœ¨æ„Ÿâ€ï¼‰
  const h = v <= 0 ? 6 : Math.max(minH, (Math.sqrt(v) / maxSqrt) * 100);
  bar.style.height = `${h}%`;

  // âœ… streak é«˜äº®ï¼šæœ€å streak æ ¹æŸ±å­åŠ  class
  // recentDates æ˜¯ä»æ—§åˆ°æ–°ï¼Œæ‰€ä»¥ streak åŒºé—´åœ¨å°¾éƒ¨
  if (streak > 0 && idx >= recentDates.length - streak) {
    bar.classList.add("streak");
    barWrapper.classList.add("streak");
  }

  const label = document.createElement("div");
  label.classList.add("chart-bar-label");
  label.textContent = `${d.slice(5)}\n${v}`;

  barWrapper.appendChild(bar);
  barWrapper.appendChild(label);
  readingChart.appendChild(barWrapper);
});
}

    // ========= INIT =========
    function initFromState() {
      setModeUI();
      manualDateInput.value = yesterdayString();
      manualTitleInput.value = "";
      manualPagesInput.value = "";
      manualLabelInput.value = "";

      const today = todayString();

      if (currentMode === "read") {
        const readState = getModeState("read");
        const hasTodayTasks = readState.today && readState.today.date === today && (readState.today.tasks || []).length > 0;

        if (hasTodayTasks) {
          setupSection.classList.add("hidden");
          mainSection.classList.remove("hidden");
          singleProgressArea.classList.add("hidden");
          multiProgressArea.classList.remove("hidden");
          refreshReadUI();
        } else {
          setupSection.classList.remove("hidden");
          mainSection.classList.add("hidden");
          refreshReadUI();
        }
      } else {
        const writeState = getModeState("write");
        const hasToday = writeState.today && writeState.today.date === today;

        if (hasToday) {
          setupSection.classList.add("hidden");
          mainSection.classList.remove("hidden");
          singleProgressArea.classList.remove("hidden");
          multiProgressArea.classList.add("hidden");

          totalInput.value = writeState.today.total;
          labelInput.value = writeState.today.label || "";
          updateWriteProgressDisplay(writeState.today.finished, writeState.today.total, writeState.today.label || "");
        } else {
          setupSection.classList.remove("hidden");
          mainSection.classList.add("hidden");
          totalInput.value = "";
          labelInput.value = "";
        }
        updateHistoryView();
      }
    }

    // ========= EVENTS =========
    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-mode");
        if (mode === currentMode) return;
        currentMode = mode;
        modeButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        celebrateArea.innerHTML = "";
        messageEl.textContent = "";
        initFromState();
      });
    });

    addBookBtn.addEventListener("click", () => {
      const title = bookInput.value;
      const pages = parseInt(bookPagesInput.value, 10);
      const label = bookLabelInput.value;
      if (!pages || pages <= 0) { alert("è¯·å¡«å†™ä¸€ä¸ªå¤§äº 0 çš„ç›®æ ‡é¡µæ•°ï½"); return; }
      addTodayTask(title, pages, label);
      bookInput.value = "";
      bookPagesInput.value = "";
      bookLabelInput.value = "";
    });

    clearTodayBooksBtn.addEventListener("click", () => clearTodayBookList());

    startBtn.addEventListener("click", () => {
      if (currentMode === "read") {
        const readToday = ensureReadToday();
        if (!readToday.tasks || readToday.tasks.length === 0) {
          alert("è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€æœ¬ä¹¦çš„ä»»åŠ¡ï½");
          return;
        }
        setupSection.classList.add("hidden");
        mainSection.classList.remove("hidden");
        singleProgressArea.classList.add("hidden");
        multiProgressArea.classList.remove("hidden");
        refreshReadUI();
        return;
      }

      const value = parseInt(totalInput.value, 10);
      if (!value || value <= 0) { alert("è¯·è¾“å…¥ä¸€ä¸ªå¤§äº 0 çš„ç›®æ ‡å­—æ•°ã€‚"); return; }
      const label = labelInput.value || "";
      setWriteTodayTask(value, label);

      setupSection.classList.add("hidden");
      mainSection.classList.remove("hidden");
      singleProgressArea.classList.remove("hidden");
      multiProgressArea.classList.add("hidden");
      const writeState = getModeState("write");
      updateWriteProgressDisplay(writeState.today.finished, writeState.today.total, writeState.today.label || "");
    });

    doneBtn.addEventListener("click", () => {
      if (currentMode !== "write") return;
      const writeState = getModeState("write");
      const today = todayString();
      if (!writeState.today || writeState.today.date !== today) { alert("è¯·å…ˆè®¾å®šä»Šå¤©çš„å†™ä½œç›®æ ‡~"); return; }

      let finished = writeState.today.finished || 0;
      const total = writeState.today.total || 0;
      const label = writeState.today.label || "";
      const wasCompleted = total > 0 && finished >= total;

      finished += WRITE_STEP;
      updateWriteTodayFinished(finished);
      updateWriteProgressDisplay(finished, total, label);

      const nowCompleted = total > 0 && finished >= total;
      if (!wasCompleted && nowCompleted) showCelebrate(true);
      else showCelebrate(false);
    });

    // æ’¤é”€ï¼šé˜…è¯»æ’¤é”€æœ€è¿‘ä¸€æ¬¡ç‚¹çš„ä¹¦ï¼›å†™ä½œæ’¤é”€100
    undoBtn.addEventListener("click", () => {
      const today = todayString();

      if (currentMode === "write") {
        const writeState = getModeState("write");
        if (!writeState.today || writeState.today.date !== today) { alert("ä»Šå¤©è¿˜æ²¡æœ‰å¯ä»¥æ’¤é”€çš„è®°å½•ï½"); return; }
        let finished = writeState.today.finished || 0;
        if (finished <= 0) { alert("å½“å‰å®Œæˆæ•°å·²ç»æ˜¯ 0 äº†ï½"); return; }
        finished = Math.max(0, finished - WRITE_STEP);
        updateWriteTodayFinished(finished);
        updateWriteProgressDisplay(finished, writeState.today.total, writeState.today.label || "");
        messageEl.textContent = "å·²æ’¤é”€ä¸€æ­¥ âœ…";
        return;
      }

      const readState = getModeState("read");
      if (!readState.today || readState.today.date !== today || !(readState.today.tasks || []).length) {
        alert("ä»Šå¤©è¿˜æ²¡æœ‰å¯ä»¥æ’¤é”€çš„é˜…è¯»è®°å½•ï½");
        return;
      }
      const lastId = readState.today.lastTouchedTaskId;
      const task = lastId ? readState.today.tasks.find(t => t.id === lastId) : readState.today.tasks[0];
      if (!task) { alert("æ²¡æœ‰æ‰¾åˆ°å¯æ’¤é”€çš„ä¹¦ï½"); return; }
      if ((task.finished || 0) <= 0) { alert("è¿™æœ¬ä¹¦å½“å‰å®Œæˆæ•°å·²ç»æ˜¯ 0 äº†ï½"); return; }

      task.finished = Math.max(0, Number(task.finished || 0) - 1);
      upsertReadHistoryForTodayTask(task);
      saveState();
      refreshReadUI();
      messageEl.textContent = `å·²æ’¤é”€ï¼š${task.title} -1 é¡µ âœ…`;
    });

    // é‡ç½®ä»Šå¤©
    resetTodayBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šè¦é‡ç½®ä»Šå¤©çš„è®°å½•å—ï¼Ÿï¼ˆä»Šå¤©å®Œæˆæ•°å½’é›¶ï¼Œç›®æ ‡ä¿ç•™ï¼‰")) return;
      const today = todayString();

      if (currentMode === "write") {
        const writeState = getModeState("write");
        if (!writeState.today || writeState.today.date !== today) { alert("ä»Šå¤©è¿˜æ²¡æœ‰è®¾ç½®ä»»åŠ¡ï¼Œæ— éœ€é‡ç½®ï½"); return; }
        updateWriteTodayFinished(0);
        updateWriteProgressDisplay(0, writeState.today.total, writeState.today.label || "");
        messageEl.textContent = "å·²é‡ç½®ä»Šå¤©çš„å†™ä½œè®°å½• âœ…";
        return;
      }

      const readState = getModeState("read");
      if (!readState.today || readState.today.date !== today || !(readState.today.tasks || []).length) {
        alert("ä»Šå¤©è¿˜æ²¡æœ‰è®¾ç½®ä¹¦å•ï¼Œæ— éœ€é‡ç½®ï½");
        return;
      }

      readState.today.tasks.forEach(t => {
        t.finished = 0;
        upsertReadHistoryForTodayTask(t);
      });
      readState.today.lastTouchedTaskId = null;
      saveState();
      refreshReadUI();
      messageEl.textContent = "å·²é‡ç½®ä»Šå¤©çš„é˜…è¯»ä¹¦å• âœ…";
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("âš ï¸ ç¡®è®¤æ¸…ç©ºæ‰€æœ‰é˜…è¯» / å†™ä½œæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
      state = { read: { today: null, history: [] }, write: { today: null, history: [] } };
      saveState();
      initFromState();
      alert("æ‰€æœ‰æ•°æ®å·²æ¸…ç©º âœ…");
    });

    manualAddBtn.addEventListener("click", () => {
      const dateStr = manualDateInput.value;
      const pages = parseInt(manualPagesInput.value, 10);
      const title = (manualTitleInput.value || "").trim();
      const label = (manualLabelInput.value || "").trim();

      if (!dateStr) { alert("è¯·å…ˆé€‰æ‹©æ—¥æœŸï½"); return; }
      if (!pages || pages <= 0) { alert("è¯·å¡«å†™ä¸€ä¸ªå¤§äº 0 çš„å®Œæˆé¡µæ•°ï½"); return; }

      const readState = getModeState("read");
      const safeTitle = title || "ï¼ˆè¡¥å½•ï¼‰";

      const idx = readState.history.findIndex(h => h.date === dateStr && (h.title || "").trim() === safeTitle);
      if (idx >= 0) {
        readState.history[idx].finished += pages;
        readState.history[idx].total += pages;
        if (label) {
          const labels = new Set([readState.history[idx].label, label].filter(Boolean)
            .join(" / ").split(" / ").map(s => s.trim()).filter(Boolean));
          readState.history[idx].label = Array.from(labels).join(" / ");
        }
      } else {
        readState.history.push({ date: dateStr, finished: pages, total: pages, label, title: safeTitle });
      }
      readState.history.sort((a,b) => a.date.localeCompare(b.date));
      saveState();
      updateHistoryView();
      alert("å·²æ‰‹åŠ¨æ·»åŠ é˜…è¯»è®°å½• âœ…");
    });

    // ========= START =========
    initFromState();
  </script>
</body>
</html>
